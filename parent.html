<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•™ë¶€ëª¨ ì „ìš© | ë¯¸ë˜ì—”ìˆ˜í•™</title>
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
    <style>
        body { margin: 0; padding: 20px; font-family: 'Pretendard', sans-serif; background: #f1f5f9; color: #333; padding-bottom: 80px; }
        .container { max-width: 600px; margin: 0 auto; }
        
        /* ë¡œê·¸ì¸ í™”ë©´ */
        #login-screen { text-align: center; margin-top: 60px; }
        .login-card { background: white; padding: 40px 20px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
        .login-input { width: 100%; padding: 16px; font-size: 18px; border: 2px solid #e2e8f0; border-radius: 12px; margin: 20px 0; box-sizing: border-box; text-align: center; outline: none; transition: 0.2s; }
        .login-input:focus { border-color: #3b82f6; }
        .login-btn { width: 100%; padding: 16px; background: #3b82f6; color: white; border: none; border-radius: 12px; font-weight: bold; font-size: 18px; cursor: pointer; transition: 0.2s; }
        .login-btn:active { transform: scale(0.98); }

        /* ë©”ì¸ í™”ë©´ */
        .card { background: white; border-radius: 20px; padding: 25px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        h2 { margin: 0 0 5px; font-size: 22px; color: #1e293b; }
        h3 { margin-top: 0; font-size: 18px; display: flex; justify-content: space-between; align-items: center; }
        
        .tag { display: inline-block; padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: bold; margin-bottom: 6px; }
        .tag-notice { background: #fff7ed; color: #c2410c; }
        .tag-counsel { background: #eff6ff; color: #1d4ed8; }
        .log-item { border-bottom: 1px dashed #e2e8f0; padding: 15px 0; }
        .log-item:last-child { border-bottom: none; }
        
        textarea { width: 100%; height: 100px; padding: 12px; border: 1px solid #cbd5e1; border-radius: 12px; box-sizing: border-box; resize: none; font-size: 15px; }
        .send-btn { width: 100%; padding: 14px; background: #10b981; color: white; border: none; border-radius: 12px; font-weight: bold; font-size: 16px; margin-top: 10px; cursor: pointer; }

        /* ë‚´ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
        .my-msg-item { background: #f8fafc; padding: 12px; border-radius: 12px; margin-bottom: 10px; border: 1px solid #e2e8f0; }
        .msg-meta { display: flex; justify-content: space-between; font-size: 12px; color: #94a3b8; margin-bottom: 6px; }
        .msg-actions button { border: none; background: none; font-size: 12px; cursor: pointer; padding: 4px 8px; border-radius: 4px; }
        .btn-edit { background: #e0f2fe; color: #0284c7; margin-right: 4px; }
        .btn-del { background: #fee2e2; color: #dc2626; }
    </style>
</head>
<body>

    <div class="container">
        <div id="login-screen">
            <div class="login-card">
                <img src="nam-192.png" style="width:80px; border-radius:20px; box-shadow: 0 8px 20px rgba(0,0,0,0.1); margin-bottom:20px;">
                <h2 style="margin-bottom:10px;">í•™ë¶€ëª¨ ì¸ì¦</h2>
                <p style="color:#64748b; font-size:15px; line-height:1.5;">
                    ì„ ìƒë‹˜ê»˜ ë“±ë¡ëœ <b>í•™ë¶€ëª¨ë‹˜ ì „í™”ë²ˆí˜¸</b>ë¥¼<br>ì…ë ¥í•´ì£¼ì„¸ìš”. (ìˆ«ìë§Œ ì…ë ¥)
                </p>
                <input type="tel" id="inputPhone" class="login-input" placeholder="01012345678">
                <button class="login-btn" onclick="checkParent()">ë‚´ ìë…€ ì¡°íšŒí•˜ê¸°</button>
            </div>
        </div>

        <div id="content-screen" style="display:none;">
            <div class="card" style="text-align:center;">
                <h2 id="sName">-</h2>
                <p id="sInfo" style="color:#64748b;">-</p>
                <div style="background:#f0f9ff; color:#0369a1; padding:12px; border-radius:12px; font-weight:bold; margin-top:15px;">
                    ğŸ“… ì´ë²ˆ ë‹¬ ë“±ì›: <span id="sAtt" style="font-size:1.2em;">0</span>íšŒ
                </div>
            </div>

            <div class="card">
                <h3>ğŸ“¢ ìµœì‹  ì•Œë¦¼ì¥</h3>
                <div id="sNotice" style="background:#fffbeb; padding:15px; border-radius:12px; border:1px solid #fcd34d; line-height:1.6; white-space:pre-wrap; color:#451a03;">(ë‚´ìš© ì—†ìŒ)</div>
            </div>

            <div class="card">
                <h3>ğŸ—‚ï¸ ì „ì²´ í•™ìŠµ/ìƒë‹´ ê¸°ë¡</h3>
                <div id="historyList" style="max-height:400px; overflow-y:auto;"></div>
            </div>

            <div class="card">
                <h3>ğŸ’¬ ì„ ìƒë‹˜ê»˜ ë‹µì¥í•˜ê¸°</h3>
                <textarea id="replyMsg" placeholder="ì„ ìƒë‹˜ê»˜ ë“œë¦´ ë§ì”€ì´ë‚˜ ê¶ê¸ˆí•œ ì ì„ ì ì–´ì£¼ì„¸ìš”."></textarea>
                <button class="send-btn" onclick="sendReply()">ë©”ì‹œì§€ ë³´ë‚´ê¸°</button>
                
                <div style="margin-top: 25px; padding-top: 15px; border-top: 2px dashed #e2e8f0;">
                    <h4 style="margin: 0 0 10px 0; font-size: 15px; color: #475569;">ğŸ“¤ ë‚´ê°€ ë³´ë‚¸ ë©”ì‹œì§€</h4>
                    <div id="myMsgList">
                        <div style="text-align:center; color:#cbd5e1; padding:10px;">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                    </div>
                </div>
            </div>
            
            <button onclick="location.reload()" style="width:100%; padding:12px; background:#94a3b8; color:white; border:none; border-radius:12px; margin-top:10px; font-weight:bold;">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        // [ìˆ˜ì •] í•„ìš”í•œ ê¸°ëŠ¥(onSnapshot, updateDoc, deleteDoc ë“±) ëª¨ë‘ ì¶”ê°€
        import { getFirestore, collection, getDocs, query, where, addDoc, serverTimestamp, onSnapshot, doc, updateDoc, deleteDoc, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDPLl5y5xMBL07yLyQDU185qfYLa4c3yv4",
            authDomain: "namyang-f3a98.firebaseapp.com",
            projectId: "namyang-f3a98",
            storageBucket: "namyang-f3a98.firebasestorage.app",
            messagingSenderId: "641432133626",
            appId: "1:641432133626:web:4d31e36d5dbb0db4df4e43",
            measurementId: "G-23L6KZERMF"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        let currentStudent = null;

        // 1. ë¡œê·¸ì¸ ë° í•™ìƒ ì¡°íšŒ
        window.checkParent = async () => {
            const phoneInput = document.getElementById('inputPhone');
            const phone = phoneInput.value.replace(/-/g, '').trim();
            
            if(phone.length < 8) return alert("ì „í™”ë²ˆí˜¸ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.");

            const btn = document.querySelector('.login-btn');
            const originalText = btn.innerText;
            btn.innerText = "ì¡°íšŒ ì¤‘...";
            btn.disabled = true;

            try {
                const q = query(collection(db, "students"), where("phone", "==", phone));
                const snap = await getDocs(q);

                if(snap.empty) {
                    alert("ë“±ë¡ëœ ë²ˆí˜¸ê°€ ì—†ìŠµë‹ˆë‹¤.\nì„ ìƒë‹˜ê»˜ í™•ì¸í•´ì£¼ì„¸ìš”.");
                    btn.innerText = originalText;
                    btn.disabled = false;
                    return;
                }

                currentStudent = { id: snap.docs[0].id, ...snap.docs[0].data() };
                showData();
                loadMyMessages(); // ë‚´ ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹œì‘

            } catch(e) {
                console.error(e);
                alert("ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                btn.innerText = originalText;
                btn.disabled = false;
            }
        };

        // 2. ë°ì´í„° í‘œì‹œ (ìµœì‹  ì•Œë¦¼ + ì „ì²´ ë‚´ì—­)
        function showData() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('content-screen').style.display = 'block';
            
            const s = currentStudent;
            document.getElementById('sName').innerText = s.name + " í•™ìƒ";
            document.getElementById('sInfo').innerText = `${s.school||''} | ${s.belt||''}`;
            document.getElementById('sNotice').innerText = s.lastNotice || "ìµœì‹  ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.";

            // ì¶œì„ ìˆ˜
            const now = new Date();
            const logs = (s.attendanceLog || []).map(ts => ts.toDate ? ts.toDate() : new Date(ts.seconds * 1000));
            const count = logs.filter(d => d.getMonth() === now.getMonth()).length;
            document.getElementById('sAtt').innerText = count;

            // [ìˆ˜ì •] ì „ì²´ ê¸°ë¡ í‘œì‹œ (ìµœì‹ ìˆœ ì •ë ¬)
            const list = document.getElementById('historyList');
            list.innerHTML = "";
            
            // ë°°ì—´ ë³µì‚¬ í›„ ì—­ìˆœ ì •ë ¬ (ì›ë³¸ í›¼ì† ë°©ì§€)
            const history = [...(s.counselLog || [])].reverse();
            
            if(history.length === 0) list.innerHTML = "<div style='text-align:center; color:#999; padding:20px;'>ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>";
            else {
                history.forEach(h => {
                    const isNotice = h.text.includes("[ì•Œë¦¼ì¥]");
                    const tag = isNotice ? '<span class="tag tag-notice">ì•Œë¦¼ì¥</span>' : '<span class="tag tag-counsel">ì§€ë„ë‚´ì—­</span>';
                    // íƒœê·¸ ì œê±°í•˜ê³  ë³¸ë¬¸ë§Œ ê¹”ë”í•˜ê²Œ
                    const cleanText = h.text.replace("[ì•Œë¦¼ì¥]", "").trim();
                    
                    list.innerHTML += `
                        <div class="log-item">
                            <div style="font-size:13px; color:#64748b; margin-bottom:4px; font-weight:bold;">ğŸ“… ${h.date}</div>
                            ${tag}
                            <div style="margin-top:6px; line-height:1.5; white-space:pre-wrap;">${cleanText}</div>
                        </div>`;
                });
            }
        }

        // 3. ë©”ì‹œì§€ ì „ì†¡
        window.sendReply = async () => {
            const msg = document.getElementById('replyMsg').value.trim();
            if(!msg) return alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            
            try {
                await addDoc(collection(db, "parentMessages"), {
                    studentId: currentStudent.id,
                    studentName: currentStudent.name,
                    message: msg,
                    createdAt: serverTimestamp(),
                    read: false
                });
                alert("ì„ ìƒë‹˜ê»˜ ë©”ì‹œì§€ë¥¼ ë³´ëƒˆìŠµë‹ˆë‹¤! âœ…");
                document.getElementById('replyMsg').value = "";
            } catch(e) { alert("ì „ì†¡ ì‹¤íŒ¨: " + e.message); }
        };

        // 4. [ì¶”ê°€] ë‚´ê°€ ë³´ë‚¸ ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ê¸° & ìˆ˜ì •/ì‚­ì œ ê¸°ëŠ¥
        function loadMyMessages() {
            if(!currentStudent) return;
            const listArea = document.getElementById('myMsgList');

            // ë‚´ í•™ìƒ IDë¡œ ëœ ë©”ì‹œì§€ë§Œ ì‹¤ì‹œê°„ ê°ì‹œ
            // (ì£¼ì˜: ì¸ë±ìŠ¤ ì˜¤ë¥˜ ë°©ì§€ë¥¼ ìœ„í•´ orderByëŠ” jsì—ì„œ ì²˜ë¦¬í•˜ê±°ë‚˜, ì—ëŸ¬ë‚˜ë©´ ìƒì„± ë§í¬ í´ë¦­ í•„ìš”)
            const q = query(
                collection(db, "parentMessages"), 
                where("studentId", "==", currentStudent.id)
            );

            onSnapshot(q, (snapshot) => {
                const msgs = [];
                snapshot.forEach(doc => msgs.push({ id: doc.id, ...doc.data() }));
                
                // ìµœì‹ ìˆœ ì •ë ¬ (í´ë¼ì´ì–¸íŠ¸ ì¸¡ ì •ë ¬)
                msgs.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));

                if(msgs.length === 0) {
                    listArea.innerHTML = "<div style='text-align:center; color:#cbd5e1; padding:10px;'>ë³´ë‚¸ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>";
                    return;
                }

                listArea.innerHTML = "";
                msgs.forEach(m => {
                    const date = m.createdAt ? new Date(m.createdAt.seconds * 1000).toLocaleString() : "ë°©ê¸ˆ ì „";
                    const isRead = m.read ? '<span style="color:#3b82f6;">(ì½ìŒ)</span>' : '<span style="color:#ef4444;">(ì•ˆì½ìŒ)</span>';
                    
                    listArea.innerHTML += `
                        <div class="my-msg-item">
                            <div class="msg-meta">
                                <span>${date} ${isRead}</span>
                                <div class="msg-actions">
                                    <button class="btn-edit" onclick="window.editMsg('${m.id}', '${m.message.replace(/'/g, "\\'")}')">ìˆ˜ì •</button>
                                    <button class="btn-del" onclick="window.delMsg('${m.id}')">ì‚­ì œ</button>
                                </div>
                            </div>
                            <div style="white-space:pre-wrap; font-size:14px;">${m.message}</div>
                        </div>
                    `;
                });
            });
        }

        // ìˆ˜ì • ê¸°ëŠ¥
        window.editMsg = async (id, oldText) => {
            const newText = prompt("ë©”ì‹œì§€ë¥¼ ìˆ˜ì •í•˜ì„¸ìš”:", oldText);
            if(newText === null || newText.trim() === "") return;
            try {
                await updateDoc(doc(db, "parentMessages", id), { message: newText });
            } catch(e) { alert("ìˆ˜ì • ì‹¤íŒ¨: " + e.message); }
        };

        // ì‚­ì œ ê¸°ëŠ¥
        window.delMsg = async (id) => {
            if(!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            try {
                await deleteDoc(doc(db, "parentMessages", id));
            } catch(e) { alert("ì‚­ì œ ì‹¤íŒ¨: " + e.message); }
        };
    </script>
</body>
</html>
