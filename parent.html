<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•™ë¶€ëª¨ ì „ìš© | ë¯¸ë˜ì—”ìˆ˜í•™</title>
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
    <style>
        body { margin: 0; padding: 20px; font-family: 'Pretendard', sans-serif; background: #f1f5f9; color: #333; padding-bottom: 80px; }
        .container { max-width: 600px; margin: 0 auto; }
        
        /* ë¡œê·¸ì¸ í™”ë©´ */
        #login-screen { text-align: center; margin-top: 60px; }
        .login-card { background: white; padding: 40px 20px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
        .login-input { width: 100%; padding: 16px; font-size: 18px; border: 2px solid #e2e8f0; border-radius: 12px; margin: 20px 0; box-sizing: border-box; text-align: center; outline: none; transition: 0.2s; }
        .login-input:focus { border-color: #3b82f6; }
        .login-btn { width: 100%; padding: 16px; background: #3b82f6; color: white; border: none; border-radius: 12px; font-weight: bold; font-size: 18px; cursor: pointer; transition: 0.2s; }
        .login-btn:active { transform: scale(0.98); }

        /* ë©”ì¸ í™”ë©´ */
        .card { background: white; border-radius: 20px; padding: 25px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        h2 { margin: 0 0 5px; font-size: 22px; color: #1e293b; }
        h3 { margin-top: 0; font-size: 18px; display: flex; justify-content: space-between; align-items: center; }
        
        .tag { display: inline-block; padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: bold; margin-bottom: 6px; }
        .tag-notice { background: #fff7ed; color: #c2410c; }
        .tag-counsel { background: #eff6ff; color: #1d4ed8; }
        .log-item { border-bottom: 1px dashed #e2e8f0; padding: 15px 0; }
        .log-item:last-child { border-bottom: none; }
        
        textarea { width: 100%; height: 100px; padding: 12px; border: 1px solid #cbd5e1; border-radius: 12px; box-sizing: border-box; resize: none; font-size: 15px; }
        .send-btn { width: 100%; padding: 14px; background: #10b981; color: white; border: none; border-radius: 12px; font-weight: bold; font-size: 16px; margin-top: 10px; cursor: pointer; }

        /* ë‚´ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
        .my-msg-item { background: #f8fafc; padding: 12px; border-radius: 12px; margin-bottom: 10px; border: 1px solid #e2e8f0; }
        .msg-meta { display: flex; justify-content: space-between; font-size: 12px; color: #94a3b8; margin-bottom: 6px; }
        .msg-actions button { border: none; background: none; font-size: 12px; cursor: pointer; padding: 4px 8px; border-radius: 4px; }
        .btn-edit { background: #e0f2fe; color: #0284c7; margin-right: 4px; }
        .btn-del { background: #fee2e2; color: #dc2626; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>

    <div class="container">
        <div id="login-screen">
            <div class="login-card">
                <img src="nam-192.png" style="width:80px; border-radius:20px; box-shadow: 0 8px 20px rgba(0,0,0,0.1); margin-bottom:20px;">
                <h2 style="margin-bottom:10px;">í•™ë¶€ëª¨ ì¸ì¦</h2>
                <p style="color:#64748b; font-size:15px; line-height:1.5;">
                    ì„ ìƒë‹˜ê»˜ ë“±ë¡ëœ <b>í•™ë¶€ëª¨ë‹˜ ì „í™”ë²ˆí˜¸</b>ë¥¼<br>ì…ë ¥í•´ì£¼ì„¸ìš”. (ìˆ«ìë§Œ ì…ë ¥)
                </p>
                <input type="tel" id="inputPhone" class="login-input" placeholder="01012345678">
                <button class="login-btn" onclick="checkParent()">ë‚´ ìë…€ ì¡°íšŒí•˜ê¸°</button>
            </div>
        </div>

        <div id="content-screen" style="display:none;">
            <div class="card" style="text-align:center;">
                <h2 id="sName">-</h2>
                <p id="sInfo" style="color:#64748b;">-</p>
                <div style="background:#f0f9ff; color:#0369a1; padding:12px; border-radius:12px; font-weight:bold; margin-top:15px;">
                    ğŸ“… ì´ë²ˆ ë‹¬ ë“±ì›: <span id="sAtt" style="font-size:1.2em;">0</span>íšŒ
                </div>
            </div>

            <div class="card">
                <h3>ğŸ“¢ ìµœì‹  ì•Œë¦¼ì¥</h3>
                <div id="sNotice" style="background:#fffbeb; padding:15px; border-radius:12px; border:1px solid #fcd34d; line-height:1.6; white-space:pre-wrap; color:#451a03;">(ë‚´ìš© ì—†ìŒ)</div>
            <button onclick="openParentMsgPopup()" style="width:100%; padding:12px; background:#f97316; color:white; border:none; border-radius:12px; margin-top:10px; font-weight:bold;">
                âœï¸ í•™ë¶€ëª¨ ì˜ê²¬ ë‚¨ê¸°ê¸°
            </button>

            </div>

            <div class="card">
                <h3>ğŸ—‚ï¸ ì „ì²´ í•™ìŠµ/ìƒë‹´ ê¸°ë¡</h3>
                <div id="historyList" style="max-height:400px; overflow-y:auto;"></div>
            </div>



            <div class="card">
                <h3>ğŸ“ˆ ì„±ì  & ì„±ì  ê·¸ë˜í”„</h3>
                <div style="background:#f8fafc; border:1px solid #e2e8f0; border-radius:14px; padding:14px;">
                    <canvas id="scoreChart" height="180"></canvas>
                </div>
                <div id="scoreList" style="margin-top:12px;"></div>
            </div>

            <div class="card">
                <h3>ğŸ“ ìƒë‹´ ê²Œì‹œíŒ</h3>
                <div style="font-size:13px; color:#64748b; line-height:1.5; margin-bottom:10px;">
                    ì„ ìƒë‹˜ ê¸°ë¡(ì•Œë¦¼ì¥/ì§€ë„ë‚´ì—­)ê³¼ í•™ë¶€ëª¨ ì˜ê²¬ì„ ì‹œê°„ìˆœìœ¼ë¡œ ëª¨ì•„ ë³´ì—¬ì¤ë‹ˆë‹¤.
                </div>
                <div id="boardList" style="max-height:420px; overflow-y:auto;"></div>
            </div>
            <div class="card">
                <h3>ğŸ’¬ ì„ ìƒë‹˜ê»˜ ë‹µì¥í•˜ê¸°</h3>
                <textarea id="replyMsg" placeholder="ì„ ìƒë‹˜ê»˜ ë“œë¦´ ë§ì”€ì´ë‚˜ ê¶ê¸ˆí•œ ì ì„ ì ì–´ì£¼ì„¸ìš”."></textarea>
                <button class="send-btn" onclick="sendReply()">ë©”ì‹œì§€ ë³´ë‚´ê¸°</button>
                
                <div style="margin-top: 25px; padding-top: 15px; border-top: 2px dashed #e2e8f0;">
                    <h4 style="margin: 0 0 10px 0; font-size: 15px; color: #475569;">ğŸ“¤ ë‚´ê°€ ë³´ë‚¸ ë©”ì‹œì§€</h4>
                    <div id="myMsgList">
                        <div style="text-align:center; color:#cbd5e1; padding:10px;">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                    </div>
                </div>
            </div>
            
            <button onclick="location.reload()" style="width:100%; padding:12px; background:#94a3b8; color:white; border:none; border-radius:12px; margin-top:10px; font-weight:bold;">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        // [ìˆ˜ì •] í•„ìš”í•œ ê¸°ëŠ¥(onSnapshot, updateDoc, deleteDoc ë“±) ëª¨ë‘ ì¶”ê°€
        import {getFirestore, collection, getDocs, query, where, addDoc, serverTimestamp, onSnapshot, doc, updateDoc, deleteDoc, orderBy, arrayUnion} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDPLl5y5xMBL07yLyQDU185qfYLa4c3yv4",
            authDomain: "namyang-f3a98.firebaseapp.com",
            projectId: "namyang-f3a98",
            storageBucket: "namyang-f3a98.firebasestorage.app",
            messagingSenderId: "641432133626",
            appId: "1:641432133626:web:4d31e36d5dbb0db4df4e43",
            measurementId: "G-23L6KZERMF"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        let currentStudent = null;

// =========================================================
// [ì¶”ê°€] í•™ë¶€ëª¨ ì˜ê²¬ ì €ì¥ (í•™ìƒë³„ ì„œë¸Œì»¬ë ‰ì…˜)
// ì €ì¥ ìœ„ì¹˜: students/{studentId}/parentMessages
// =========================================================
window.openParentMsgPopup = () => {
  if(!currentStudent || !currentStudent.id) return alert("í•™ìƒ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì¡°íšŒí•´ì£¼ì„¸ìš”.");
  const pop = document.getElementById('parentMsgPopup');
  const ta = document.getElementById('parentMsgText');
  if(ta) ta.value = '';
  if(pop) pop.style.display = 'block';
};
window.closeParentMsgPopup = () => {
  const pop = document.getElementById('parentMsgPopup');
  if(pop) pop.style.display = 'none';
};

window.submitParentMsg = async () => {
  if(!currentStudent || !currentStudent.id) return alert("í•™ìƒ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
  const ta = document.getElementById('parentMsgText');
  const text = (ta?.value || '').trim();
  if(!text) return alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
  const phone = (document.getElementById('inputPhone')?.value || '').replace(/-/g,'').trim();
  const payload = {
    text,
    createdAtMs: Date.now(),
    authorPhone: phone,
    role: 'parent'
  };
  try{
    // âœ… ê°€ì¥ ì•ˆì •ì ì¸ ë°©ì‹: í•™ìƒ ë¬¸ì„œì— ë°°ì—´ë¡œ ì €ì¥(ê¶Œí•œ/ì„œë¸Œì»¬ë ‰ì…˜ ì´ìŠˆ íšŒí”¼)
    await updateDoc(doc(db,'students',currentStudent.id), {
      parentOpinions: arrayUnion(payload),
      // ìƒë‹´ë‚´ì—­ì—ë„ í•¨ê»˜ ë‚¨ê²¨ ì„ ìƒë‹˜/í•™ë¶€ëª¨ ëª¨ë‘ íˆìŠ¤í† ë¦¬ì— ë³´ì´ê²Œ
      counselLog: arrayUnion({ date: new Date().toLocaleDateString(), text: '[í•™ë¶€ëª¨ì˜ê²¬] ' + text })
    });

    // ë¡œì»¬ ìƒíƒœì—ë„ ì¦‰ì‹œ ë°˜ì˜(ë¦¬ë¡œë“œ ì—†ì´ ë°”ë¡œ ë³´ì´ê²Œ)
    const arr = Array.isArray(currentStudent.parentOpinions) ? currentStudent.parentOpinions.slice() : [];
    arr.unshift(payload);
    currentStudent.parentOpinions = arr;

    window.closeParentMsgPopup();
    alert('ì˜ê²¬ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
    // í™”ë©´ ê°±ì‹ 
    try{ showData(); }catch(e){}
    try{ attachParentMsgFeed(); }catch(e){}
  }catch(e){
    console.error(e);
    alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.
' + (e?.message || e));
  }
};

// í•™ìƒë³„ í•™ë¶€ëª¨ ì˜ê²¬ ëª©ë¡ì„ ìƒë‹´ë‚´ì—­(historyList) ë§¨ ìœ„ì— í•¨ê»˜ ë³´ì—¬ì¤Œ
let __parentMsgUnsub = null;
function fmtTs(ts){
  try{
    const d = ts?.toDate ? ts.toDate() : (ts?.seconds ? new Date(ts.seconds*1000) : null);
    if(!d) return '';
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    const hh = String(d.getHours()).padStart(2,'0');
    const mi = String(d.getMinutes()).padStart(2,'0');
    return `${d.getFullYear()}-${mm}-${dd} ${hh}:${mi}`;
  }catch(e){ return ''; }
}

function attachParentMsgFeed(){
  try{
    const host = document.getElementById('historyList');
    if(!host || !currentStudent) return;

    const wrapId = 'parentMsgFeed';
    let wrap = document.getElementById(wrapId);
    if(!wrap){
      wrap = document.createElement('div');
      wrap.id = wrapId;
      wrap.style.marginBottom = '12px';
      host.prepend(wrap);
    }

    const arr = Array.isArray(currentStudent.parentOpinions) ? currentStudent.parentOpinions.slice() : [];
    // ìµœì‹ ìˆœ
    arr.sort((a,b)=>(b?.createdAtMs||0)-(a?.createdAtMs||0));

    if(arr.length===0){
      wrap.innerHTML = `<div style="background:#fff7ed; border:1px solid #fed7aa; border-radius:12px; padding:12px; color:#9a3412;">
        <b>ğŸ“ í•™ë¶€ëª¨ ì˜ê²¬</b><div style="margin-top:6px; color:#94a3b8;">ë“±ë¡ëœ ì˜ê²¬ì´ ì—†ìŠµë‹ˆë‹¤.</div>
      </div>`;
      return;
    }

    const esc = (s)=>String(s||'').replace(/[<>&]/g, c=>({ '<':'&lt;','>':'&gt;','&':'&amp;' }[c]));
    const fmt = (ms)=>{
      try{
        const d = new Date(ms);
        const mm = String(d.getMonth()+1).padStart(2,'0');
        const dd = String(d.getDate()).padStart(2,'0');
        const hh = String(d.getHours()).padStart(2,'0');
        const mi = String(d.getMinutes()).padStart(2,'0');
        return `${d.getFullYear()}-${mm}-${dd} ${hh}:${mi}`;
      }catch(e){ return ''; }
    };

    wrap.innerHTML = `<div style="background:#fff7ed; border:1px solid #fed7aa; border-radius:12px; padding:12px;">
      <div style="font-weight:bold; color:#9a3412; margin-bottom:8px;">ğŸ“ í•™ë¶€ëª¨ ì˜ê²¬</div>
      ${arr.map(v=>{
        const t = esc(v.text);
        return `<div style="background:#fff; border:1px solid #fed7aa; border-radius:10px; padding:10px; margin-top:8px;">
          <div style="display:flex; justify-content:space-between; gap:10px;">
            <div style="font-weight:bold; color:#7c2d12;">ì˜ê²¬</div>
            <div style="font-size:12px; color:#9ca3af;">${fmt(v.createdAtMs)}</div>
          </div>
          <div style="white-space:pre-wrap; margin-top:6px; line-height:1.45;">${t}</div>
        </div>`;
      }).join('')}
    </div>`;
  }catch(e){
    console.error(e);
  }
}



        // 1. ë¡œê·¸ì¸ ë° í•™ìƒ ì¡°íšŒ
        window.checkParent = async () => {
            const phoneInput = document.getElementById('inputPhone');
            const phone = phoneInput.value.replace(/-/g, '').trim();
            
            if(phone.length < 8) return alert("ì „í™”ë²ˆí˜¸ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.");

            const btn = document.querySelector('.login-btn');
            const originalText = btn.innerText;
            btn.innerText = "ì¡°íšŒ ì¤‘...";
            btn.disabled = true;

            try {
                const q = query(collection(db, "students"), where("phone", "==", phone));
                const snap = await getDocs(q);

                if(snap.empty) {
                    alert("ë“±ë¡ëœ ë²ˆí˜¸ê°€ ì—†ìŠµë‹ˆë‹¤.\nì„ ìƒë‹˜ê»˜ í™•ì¸í•´ì£¼ì„¸ìš”.");
                    btn.innerText = originalText;
                    btn.disabled = false;
                    return;
                }

                currentStudent = { id: snap.docs[0].id, ...snap.docs[0].data() };
                showData();
                attachParentMsgFeed();
                loadMyMessages(); // ë‚´ ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹œì‘
                loadBoard();
                renderScores();

                // í•™ìƒ ì •ë³´/ì ìˆ˜/ìƒë‹´ ê¸°ë¡ì´ ë³€ê²½ë˜ë©´ ì‹¤ì‹œê°„ ë°˜ì˜
                if(typeof __studentUnsub === 'function') { try { __studentUnsub(); } catch(e){} }
                __studentUnsub = onSnapshot(doc(db, 'students', currentStudent.id), (d) => {
                    if(!d.exists()) return;
                    currentStudent = { id: d.id, ...d.data() };
                    showData();
                attachParentMsgFeed();
                    renderScores();
                    loadBoard();
                });

            } catch(e) {
                console.error(e);
                alert("ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                btn.innerText = originalText;
                btn.disabled = false;
            }
        };

        // 2. ë°ì´í„° í‘œì‹œ (ìµœì‹  ì•Œë¦¼ + ì „ì²´ ë‚´ì—­)
        function showData() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('content-screen').style.display = 'block';
            
            const s = currentStudent;
            document.getElementById('sName').innerText = s.name + " í•™ìƒ";
            document.getElementById('sInfo').innerText = `${s.school||''} | ${s.belt||''}`;
            document.getElementById('sNotice').innerText = s.lastNotice || "ìµœì‹  ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.";

            // ì¶œì„ ìˆ˜
            const now = new Date();
            const logs = (s.attendanceLog || []).map(ts => ts.toDate ? ts.toDate() : new Date(ts.seconds * 1000));
            const count = logs.filter(d => d.getMonth() === now.getMonth()).length;
            document.getElementById('sAtt').innerText = count;

            // [ìˆ˜ì •] ì „ì²´ ê¸°ë¡ í‘œì‹œ (ìµœì‹ ìˆœ ì •ë ¬)
            const list = document.getElementById('historyList');
            list.innerHTML = "";
            
            // ë°°ì—´ ë³µì‚¬ í›„ ì—­ìˆœ ì •ë ¬ (ì›ë³¸ í›¼ì† ë°©ì§€)
            const history = [...(s.counselLog || [])].reverse();
            
            if(history.length === 0) list.innerHTML = "<div style='text-align:center; color:#999; padding:20px;'>ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>";
            else {
                history.forEach(h => {
                    const isNotice = h.text.includes("[ì•Œë¦¼ì¥]");
                    const tag = isNotice ? '<span class="tag tag-notice">ì•Œë¦¼ì¥</span>' : '<span class="tag tag-counsel">ì§€ë„ë‚´ì—­</span>';
                    // íƒœê·¸ ì œê±°í•˜ê³  ë³¸ë¬¸ë§Œ ê¹”ë”í•˜ê²Œ
                    const cleanText = h.text.replace("[ì•Œë¦¼ì¥]", "").trim();
                    
                    list.innerHTML += `
                        <div class="log-item">
                            <div style="font-size:13px; color:#64748b; margin-bottom:4px; font-weight:bold;">ğŸ“… ${h.date}</div>
                            ${tag}
                            <div style="margin-top:6px; line-height:1.5; white-space:pre-wrap;">${cleanText}</div>
                        </div>`;
                });
            }
        }

        // 3. ë©”ì‹œì§€ ì „ì†¡
        window.sendReply = async () => {
            const msg = document.getElementById('replyMsg').value.trim();
            if(!msg) return alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            
            try {
                await addDoc(collection(db, "parentMessages"), {
                    studentId: currentStudent.id,
                    studentName: currentStudent.name,
                    message: msg,
                    createdAt: serverTimestamp(),
                    read: false
                });
                alert("ì„ ìƒë‹˜ê»˜ ë©”ì‹œì§€ë¥¼ ë³´ëƒˆìŠµë‹ˆë‹¤! âœ…");
                document.getElementById('replyMsg').value = "";
            } catch(e) { alert("ì „ì†¡ ì‹¤íŒ¨: " + e.message); }
        };

       // [ìˆ˜ì •] ë‚´ê°€ ë³´ë‚¸ ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ê¸° (ì •ë ¬ ì—ëŸ¬ í•´ê²°)
        function loadMyMessages() {
            if(!currentStudent) return;
            const listArea = document.getElementById('myMsgList');

            // [í•µì‹¬] orderBy ì œê±°
            const q = query(
                collection(db, "parentMessages"), 
                where("studentId", "==", currentStudent.id)
            );

            onSnapshot(q, (snapshot) => {
                const msgs = [];
                snapshot.forEach(doc => msgs.push({ id: doc.id, ...doc.data() }));
                
                // [í•µì‹¬] ìë°”ìŠ¤í¬ë¦½íŠ¸ë¡œ ìµœì‹ ìˆœ ì •ë ¬
                msgs.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));

                if(msgs.length === 0) {
                    listArea.innerHTML = "<div style='text-align:center; color:#cbd5e1; padding:10px;'>ë³´ë‚¸ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>";
                    return;
                }

                listArea.innerHTML = "";
                msgs.forEach(m => {
                    const date = m.createdAt ? new Date(m.createdAt.seconds * 1000).toLocaleString() : "ë°©ê¸ˆ ì „";
                    const isRead = m.read ? '<span style="color:#3b82f6;">(ì½ìŒ)</span>' : '<span style="color:#ef4444;">(ì•ˆì½ìŒ)</span>';
                    
                    // ë©”ì‹œì§€ ìˆ˜ì •/ì‚­ì œ ì‹œ í…ìŠ¤íŠ¸ ê¹¨ì§ ë°©ì§€ ì²˜ë¦¬
                    const safeMsg = (m.message || '').replace(/'/g, "\\'"); 
                    
                    listArea.innerHTML += `
                        <div class="my-msg-item">
                            <div class="msg-meta">
                                <span>${date} ${isRead}</span>
                                <div class="msg-actions">
                                    <button class="btn-edit" onclick="window.editMsg('${m.id}', '${safeMsg}')">ìˆ˜ì •</button>
                                    <button class="btn-del" onclick="window.delMsg('${m.id}')">ì‚­ì œ</button>
                                </div>
                            </div>
                            <div style="white-space:pre-wrap; font-size:14px;">${m.message}</div>
                        </div>
                    `;
                });
            });
        }
        // ìˆ˜ì • ê¸°ëŠ¥
        window.editMsg = async (id, oldText) => {
            const newText = prompt("ë©”ì‹œì§€ë¥¼ ìˆ˜ì •í•˜ì„¸ìš”:", oldText);
            if(newText === null || newText.trim() === "") return;
            try {
                await updateDoc(doc(db, "parentMessages", id), { message: newText });
            } catch(e) { alert("ìˆ˜ì • ì‹¤íŒ¨: " + e.message); }
        };

        // ì‚­ì œ ê¸°ëŠ¥
        window.delMsg = async (id) => {
            if(!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            try {
                await deleteDoc(doc(db, "parentMessages", id));
            } catch(e) { alert("ì‚­ì œ ì‹¤íŒ¨: " + e.message); }
        };

        // =========================================================
        // [ì¶”ê°€] ì„±ì (ê·¸ë˜í”„) + ìƒë‹´ ê²Œì‹œíŒ(ì„ ìƒë‹˜ ê¸°ë¡ + í•™ë¶€ëª¨ ì˜ê²¬) ë Œë”ë§
        // =========================================================
        let __scoreChart = null;
        let __boardUnsub = null;
        let __studentUnsub = null;

        function escapeHtml(str) {
            return String(str || '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function tsToLabel(sec) {
            try {
                const d = new Date(sec * 1000);
                return d.toLocaleString();
            } catch(e) {
                return '';
            }
        }

        function koreanDateToTs(dateStr) {
            // ì˜ˆ: 2026. 1. 19. / 2026-01-19 / 2026/1/19
            const s = String(dateStr || '').trim();
            if(!s) return 0;
            const m = s.match(/(\d{4})\D+(\d{1,2})\D+(\d{1,2})/);
            if(m) {
                const y = int(m[1]);
                const mo = int(m[2]);
                const d = int(m[3]);
                const dt = new Date(y, mo-1, d);
                return Math.floor(dt.getTime()/1000);
            }
            const t = Date.parse(s);
            if(!isNaN(t)) return Math.floor(t/1000);
            return 0;
        }

        function int(x){
            const n = parseInt(x, 10);
            return isNaN(n) ? 0 : n;
        }

        window.renderScores = function renderScores() {
            if(!currentStudent) return;
            const scoreLog = Array.isArray(currentStudent.scoreLog) ? currentStudent.scoreLog : [];
            const listEl = document.getElementById('scoreList');
            const canvas = document.getElementById('scoreChart');
            if(!listEl || !canvas) return;

            // ë¦¬ìŠ¤íŠ¸
            if(scoreLog.length === 0) {
                listEl.innerHTML = "<div style='text-align:center; color:#94a3b8; padding:10px;'>ë“±ë¡ëœ ì„±ì ì´ ì—†ìŠµë‹ˆë‹¤.</div>";
            } else {
                const sorted = [...scoreLog].sort((a,b)=>{
                    const ta = koreanDateToTs(a.date) || 0;
                    const tb = koreanDateToTs(b.date) || 0;
                    return tb - ta;
                });
                listEl.innerHTML = sorted.map(s => {
                    return `
                        <div style="padding:10px; margin-bottom:8px; border-radius:12px; background:#fff; border:1px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center; gap:10px;">
                            <div>
                                <div style="font-weight:900; color:#0f172a;">${escapeHtml(s.title || 'ì‹œí—˜')}</div>
                                <div style="font-size:12px; color:#64748b; margin-top:2px;">${escapeHtml(s.date || '')}</div>
                            </div>
                            <div style="font-weight:900; font-size:16px; color:#7c3aed;">${escapeHtml(s.score)}ì </div>
                        </div>
                    `;
                }).join('');
            }

            // ê·¸ë˜í”„ ë°ì´í„° (ì˜¤ë˜ëœ -> ìµœì‹ )
            const sortedAsc = [...scoreLog].sort((a,b)=>{
                const ta = koreanDateToTs(a.date) || 0;
                const tb = koreanDateToTs(b.date) || 0;
                return ta - tb;
            });
            const labels = sortedAsc.map(s => (s.date || '').toString().slice(5) || s.title || '');
            const values = sortedAsc.map(s => int(s.score));

            // 3D ëŠë‚Œ: ë§‰ëŒ€ ë’¤ì— ì‚´ì§ "ê·¸ë¦¼ì" ë§‰ëŒ€ë¥¼ í•œ ë²ˆ ë” ê·¸ë ¤ì£¼ëŠ” í”ŒëŸ¬ê·¸ì¸
            const bar3dPlugin = {
                id: 'bar3d',
                afterDatasetsDraw(chart, args, pluginOptions) {
                    const { ctx } = chart;
                    const meta = chart.getDatasetMeta(0);
                    if(!meta || !meta.data) return;
                    ctx.save();
                    ctx.globalAlpha = 0.25;
                    meta.data.forEach((bar) => {
                        if(!bar || !bar.getProps) return;
                        const props = bar.getProps(['x','y','base','width'], true);
                        const x = props.x;
                        const y = props.y;
                        const base = props.base;
                        const w = props.width;
                        const dx = 6;
                        const dy = 6;
                        // ë’¤ìª½ ë©´(ê¸°ìš¸ê¸°)
                        ctx.fillRect(x - w/2 + dx, y + dy, w, base - y);
                    });
                    ctx.restore();
                }
            };

            // ë§‰ëŒ€ ìƒ‰ ê·¸ë¼ë°ì´ì…˜(ê¹”ë”í•œ ì‹œì¸ì„±)
            const ctx = canvas.getContext('2d');
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, 'rgba(124, 58, 237, 0.85)');
            gradient.addColorStop(1, 'rgba(124, 58, 237, 0.20)');

            if(__scoreChart) {
                __scoreChart.destroy();
                __scoreChart = null;
            }

            __scoreChart = new Chart(canvas, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ì„±ì ',
                        data: values,
                        backgroundColor: gradient,
                        borderColor: 'rgba(124, 58, 237, 0.9)',
                        borderWidth: 1,
                        borderRadius: 10
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: { callbacks: {
                            label: (ctx) => `${ctx.parsed.y}ì `
                        }}
                    },
                    scales: {
                        y: { beginAtZero: true, suggestedMax: 100, grid: { display: true } },
                        x: { grid: { display: false } }
                    }
                },
                plugins: [bar3dPlugin]
            });
        }

        window.loadBoard = function loadBoard() {
            if(!currentStudent) return;
            const boardEl = document.getElementById('boardList');
            if(!boardEl) return;

            // ê¸°ì¡´ êµ¬ë… í•´ì œ(ì¬ë¡œê·¸ì¸ ëŒ€ë¹„)
            if(typeof __boardUnsub === 'function') {
                try { __boardUnsub(); } catch(e) {}
            }

            const q = query(
                collection(db, 'parentMessages'),
                where('studentId', '==', currentStudent.id)
            );

            __boardUnsub = onSnapshot(q, (snapshot) => {
                const parentItems = [];
                snapshot.forEach(d => parentItems.push({ id: d.id, ...d.data() }));

                const teacherLogs = Array.isArray(currentStudent.counselLog) ? currentStudent.counselLog : [];

                const items = [];

                // ì„ ìƒë‹˜ ê¸°ë¡
                teacherLogs.forEach((h, idx) => {
                    const ts = koreanDateToTs(h.date) || (idx + 1);
                    const isNotice = String(h.text || '').includes('[ì•Œë¦¼ì¥]');
                    const clean = String(h.text || '').replace('[ì•Œë¦¼ì¥]', '').trim();
                    items.push({
                        type: 'teacher',
                        ts,
                        dateLabel: h.date || '',
                        title: isNotice ? 'ì•Œë¦¼ì¥' : 'ì§€ë„ë‚´ì—­',
                        text: clean
                    });
                });

                // í•™ë¶€ëª¨ ì˜ê²¬
                parentItems.forEach((m) => {
                    const ts = (m.createdAt && m.createdAt.seconds) ? m.createdAt.seconds : 0;
                    items.push({
                        type: 'parent',
                        ts,
                        id: m.id,
                        dateLabel: ts ? tsToLabel(ts) : 'ë°©ê¸ˆ ì „',
                        text: m.message || '',
                        read: m.read === true
                    });
                });

                // ì‹œê°„ìˆœ(ì˜¤ë˜ëœ -> ìµœì‹ ) / ë™ë¥ ì´ë©´ ì„ ìƒë‹˜ ë¨¼ì €
                items.sort((a,b)=>{
                    if(a.ts === b.ts) {
                        if(a.type === b.type) return 0;
                        return a.type === 'teacher' ? -1 : 1;
                    }
                    return a.ts - b.ts;
                });

                if(items.length === 0) {
                    boardEl.innerHTML = "<div style='text-align:center; color:#94a3b8; padding:18px;'>ìƒë‹´ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>";
                    return;
                }

                boardEl.innerHTML = items.map((it) => {
                    const who = it.type === 'teacher' ? 'ì„ ìƒë‹˜' : 'í•™ë¶€ëª¨';
                    const badgeBg = it.type === 'teacher' ? '#eff6ff' : '#ecfeff';
                    const badgeColor = it.type === 'teacher' ? '#1d4ed8' : '#0e7490';
                    const oldJson = JSON.stringify(it.text || '').replace(/</g, '\u003c');

                    const action = (it.type === 'parent')
                        ? `<div style="display:flex; gap:6px;">
                               <button class="btn-edit" onclick="window.editMsg('${it.id}', ${oldJson})">ìˆ˜ì •</button>
                               <button class="btn-del" onclick="window.delMsg('${it.id}')">ì‚­ì œ</button>
                           </div>`
                        : '';

                    return `
                        <div style="padding:12px; margin-bottom:10px; border-radius:14px; background:#fff; border:1px solid #e2e8f0;">
                            <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:10px; margin-bottom:6px;">
                                <div>
                                    <span style="display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; font-weight:900; background:${badgeBg}; color:${badgeColor};">${who}${it.type==='teacher' ? ' Â· ' + escapeHtml(it.title||'') : (it.read ? ' Â· ì½ìŒ' : ' Â· ì•ˆì½ìŒ')}</span>
                                    <div style="font-size:12px; color:#94a3b8; margin-top:4px;">${escapeHtml(it.dateLabel||'')}</div>
                                </div>
                                ${action}
                            </div>
                            <div style="white-space:pre-wrap; font-size:14px; line-height:1.55; color:#0f172a;">${escapeHtml(it.text||'')}</div>
                        </div>
                    `;
                }).join('');
            });
        }

    </script>

<!-- [ì¶”ê°€] í•™ë¶€ëª¨ ì˜ê²¬ ì‘ì„± íŒì—… -->
<div id="parentMsgPopup" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:9999; padding:16px;">
  <div style="max-width:520px; margin:10vh auto 0; background:#fff; border-radius:16px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.18);">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
      <div style="font-weight:bold; font-size:16px;">í•™ë¶€ëª¨ ì˜ê²¬ ì‘ì„±</div>
      <button onclick="closeParentMsgPopup()" style="border:none; background:#e2e8f0; border-radius:10px; padding:6px 10px; font-weight:bold;">ë‹«ê¸°</button>
    </div>
    <textarea id="parentMsgText" rows="6" placeholder="ì„ ìƒë‹˜ê»˜ ì „ë‹¬í•  ë‚´ìš©ì„ ì ì–´ì£¼ì„¸ìš”." style="width:100%; margin-top:10px; padding:12px; border:1px solid #cbd5e1; border-radius:12px; resize:vertical; font-size:14px;"></textarea>
    <div style="display:flex; gap:10px; margin-top:12px;">
      <button onclick="submitParentMsg()" style="flex:1; padding:12px; background:#f97316; color:#fff; border:none; border-radius:12px; font-weight:bold;">ë“±ë¡</button>
      <button onclick="closeParentMsgPopup()" style="flex:1; padding:12px; background:#94a3b8; color:#fff; border:none; border-radius:12px; font-weight:bold;">ì·¨ì†Œ</button>
    </div>
    <div style="font-size:12px; color:#64748b; margin-top:10px; line-height:1.4;">
      * ì‘ì„±í•œ ì˜ê²¬ì€ ì €ì¥ë˜ë©°, ì„ ìƒë‹˜ í™”ë©´ì—ì„œ í•™ìƒë³„ë¡œ í™•ì¸ ê°€ëŠ¥í•©ë‹ˆë‹¤.
    </div>
  </div>
</div>

</body>
</html>

