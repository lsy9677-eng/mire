<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•™ë¶€ëª¨ ì „ìš© | ë¯¸ë˜ì—”ìˆ˜í•™</title>
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
    <style>
        body { margin: 0; padding: 20px; font-family: 'Pretendard', sans-serif; background: #f1f5f9; color: #333; }
        body { margin: 0; padding: 20px; font-family: 'Pretendard', sans-serif; background: #f1f5f9; color: #333; padding-bottom: 80px; }
        .container { max-width: 600px; margin: 0 auto; }

        /* ë¡œê·¸ì¸ í™”ë©´ */
@@ -20,16 +20,24 @@
        /* ë©”ì¸ í™”ë©´ */
        .card { background: white; border-radius: 20px; padding: 25px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        h2 { margin: 0 0 5px; font-size: 22px; color: #1e293b; }
        h3 { margin-top: 0; font-size: 18px; display: flex; justify-content: space-between; align-items: center; }
        
        .tag { display: inline-block; padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: bold; margin-bottom: 6px; }
        .tag-notice { background: #fff7ed; color: #c2410c; }
        .tag-counsel { background: #eff6ff; color: #1d4ed8; }
        .log-item { border-bottom: 1px dashed #e2e8f0; padding: 12px 0; }
        .log-item { border-bottom: 1px dashed #e2e8f0; padding: 15px 0; }
        .log-item:last-child { border-bottom: none; }

        /* í•™ë¶€ëª¨ ì…ë ¥ì°½: ì‘ì•„ì„œ ì•ˆ ë³´ì¸ë‹¤ëŠ” í”¼ë“œë°± ë°˜ì˜ */
        textarea { width: 100%; height: 160px; padding: 14px; border: 1px solid #cbd5e1; border-radius: 14px; box-sizing: border-box; resize: vertical; font-size: 16px; line-height: 1.5; }
        textarea { width: 100%; height: 100px; padding: 12px; border: 1px solid #cbd5e1; border-radius: 12px; box-sizing: border-box; resize: none; font-size: 15px; }
        .send-btn { width: 100%; padding: 14px; background: #10b981; color: white; border: none; border-radius: 12px; font-weight: bold; font-size: 16px; margin-top: 10px; cursor: pointer; }

        /* ë‚´ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
        .my-msg-item { background: #f8fafc; padding: 12px; border-radius: 12px; margin-bottom: 10px; border: 1px solid #e2e8f0; }
        .msg-meta { display: flex; justify-content: space-between; font-size: 12px; color: #94a3b8; margin-bottom: 6px; }
        .msg-actions button { border: none; background: none; font-size: 12px; cursor: pointer; padding: 4px 8px; border-radius: 4px; }
        .btn-edit { background: #e0f2fe; color: #0284c7; margin-right: 4px; }
        .btn-del { background: #fee2e2; color: #dc2626; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

@@ -56,36 +64,36 @@
            </div>

            <div class="card">
                <h3 style="margin-top:0;">ğŸ“¢ ìµœì‹  ì•Œë¦¼ì¥</h3>
                <h3>ğŸ“¢ ìµœì‹  ì•Œë¦¼ì¥</h3>
                <div id="sNotice" style="background:#fffbeb; padding:15px; border-radius:12px; border:1px solid #fcd34d; line-height:1.6; white-space:pre-wrap; color:#451a03;">(ë‚´ìš© ì—†ìŒ)</div>
            </div>

            <div class="card">
                <h3 style="margin-top:0;">ğŸ—‚ï¸ ì§€ë‚œ í•™ìŠµ/ìƒë‹´ ê¸°ë¡</h3>
                <div id="historyList" style="max-height:420px; overflow-y:auto;"></div>
            </div>

            <div class="card">
                <h3 style="margin-top:0;">ğŸ“ˆ ì„±ì  ê·¸ë˜í”„/ê¸°ë¡</h3>
                <div style="background:#f5f3ff; border:1px solid #ddd6fe; padding:14px; border-radius:12px;">
                    <canvas id="parentScoreChart" height="180"></canvas>
                    <div id="parentScoreList" style="margin-top:12px; font-size:14px; line-height:1.5; color:#475569;"></div>
                </div>
                <h3>ğŸ—‚ï¸ ì „ì²´ í•™ìŠµ/ìƒë‹´ ê¸°ë¡</h3>
                <div id="historyList" style="max-height:400px; overflow-y:auto;"></div>
            </div>

            <div class="card">
                <h3 style="margin-top:0;">ğŸ’¬ ì„ ìƒë‹˜ê»˜ ë‹µì¥í•˜ê¸°</h3>
                <h3>ğŸ’¬ ì„ ìƒë‹˜ê»˜ ë‹µì¥í•˜ê¸°</h3>
                <textarea id="replyMsg" placeholder="ì„ ìƒë‹˜ê»˜ ë“œë¦´ ë§ì”€ì´ë‚˜ ê¶ê¸ˆí•œ ì ì„ ì ì–´ì£¼ì„¸ìš”."></textarea>
                <button class="send-btn" onclick="sendReply()">ë©”ì‹œì§€ ë³´ë‚´ê¸°</button>
                
                <div style="margin-top: 25px; padding-top: 15px; border-top: 2px dashed #e2e8f0;">
                    <h4 style="margin: 0 0 10px 0; font-size: 15px; color: #475569;">ğŸ“¤ ë‚´ê°€ ë³´ë‚¸ ë©”ì‹œì§€</h4>
                    <div id="myMsgList">
                        <div style="text-align:center; color:#cbd5e1; padding:10px;">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                    </div>
                </div>
            </div>

            <button onclick="location.reload()" style="width:100%; padding:12px; background:#94a3b8; color:white; border:none; border-radius:12px; margin-top:20px; font-weight:bold;">ë¡œê·¸ì•„ì›ƒ</button>
            <button onclick="location.reload()" style="width:100%; padding:12px; background:#94a3b8; color:white; border:none; border-radius:12px; margin-top:10px; font-weight:bold;">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, query, where, addDoc, serverTimestamp, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        // [ìˆ˜ì •] í•„ìš”í•œ ê¸°ëŠ¥(onSnapshot, updateDoc, deleteDoc ë“±) ëª¨ë‘ ì¶”ê°€
        import { getFirestore, collection, getDocs, query, where, addDoc, serverTimestamp, onSnapshot, doc, updateDoc, deleteDoc, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDPLl5y5xMBL07yLyQDU185qfYLa4c3yv4",
@@ -100,9 +108,8 @@
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        let currentStudent = null;
        let unsubStudent = null;
        let parentChart = null;

        // 1. ë¡œê·¸ì¸ ë° í•™ìƒ ì¡°íšŒ
        window.checkParent = async () => {
            const phoneInput = document.getElementById('inputPhone');
            const phone = phoneInput.value.replace(/-/g, '').trim();
@@ -115,7 +122,6 @@
            btn.disabled = true;

            try {
                // ë¶€ëª¨ë‹˜ ë²ˆí˜¸ë¡œ í•™ìƒ ê²€ìƒ‰
                const q = query(collection(db, "students"), where("phone", "==", phone));
                const snap = await getDocs(q);

@@ -126,15 +132,9 @@
                    return;
                }

                // ë¡œê·¸ì¸ ì„±ê³µ: í•™ìƒ docë¥¼ ì‹¤ì‹œê°„ êµ¬ë…í•´ì„œ
                // ì„ ìƒë‹˜ì´ ìƒë‹´/ì•Œë¦¼ì„ ì¶”ê°€í•´ë„ ë¶€ëª¨ í™”ë©´ì´ ìë™ìœ¼ë¡œ ê°±ì‹ ë˜ê²Œ í•¨
                const id = snap.docs[0].id;
                if (unsubStudent) try { unsubStudent(); } catch(e) {}
                unsubStudent = onSnapshot(doc(db, "students", id), (docSnap) => {
                    if(!docSnap.exists()) return;
                    currentStudent = { id: docSnap.id, ...docSnap.data() };
                    showData();
                });
                currentStudent = { id: snap.docs[0].id, ...snap.docs[0].data() };
                showData();
                loadMyMessages(); // ë‚´ ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹œì‘

            } catch(e) {
                console.error(e);
@@ -144,59 +144,7 @@
            }
        };

        function renderParentScore(scoreLog = []) {
            const canvas = document.getElementById('parentScoreChart');
            const listEl = document.getElementById('parentScoreList');
            if(!canvas || !listEl) return;

            // ë¦¬ìŠ¤íŠ¸
            if(!Array.isArray(scoreLog) || scoreLog.length === 0) {
                listEl.innerHTML = "<div style='text-align:center; color:#94a3b8; padding:10px;'>ë“±ë¡ëœ ì„±ì ì´ ì—†ìŠµë‹ˆë‹¤.</div>";
            } else {
                const rows = scoreLog.slice().reverse().map(s => {
                    const date = s.date || '';
                    const title = s.title || 'ì‹œí—˜';
                    const score = (s.score ?? '');
                    return `<div style="padding:8px 0; border-bottom:1px dashed #e2e8f0;">
                        <div style="font-size:12px; color:#94a3b8;">${date}</div>
                        <div style="display:flex; justify-content:space-between; gap:10px;">
                            <div style="font-weight:800; color:#1e293b;">${title}</div>
                            <div style="font-weight:900; color:#7c3aed;">${score}ì </div>
                        </div>
                    </div>`;
                }).join('');
                listEl.innerHTML = rows;
            }

            // ì°¨íŠ¸
            if(!window.Chart) return;
            const ctx = canvas.getContext('2d');
            if(parentChart) { try { parentChart.destroy(); } catch(e){} }

            const labels = (scoreLog || []).map(s => s.title || '');
            const data = (scoreLog || []).map(s => Number(s.score || 0));

            parentChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'ì„±ì ',
                        data,
                        tension: 0.25,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, suggestedMax: 100 }
                    }
                }
            });
        }

        // 2. ë°ì´í„° í‘œì‹œ (ìµœì‹  ì•Œë¦¼ + ì „ì²´ ë‚´ì—­)
        function showData() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('content-screen').style.display = 'block';
@@ -206,43 +154,44 @@
            document.getElementById('sInfo').innerText = `${s.school||''} | ${s.belt||''}`;
            document.getElementById('sNotice').innerText = s.lastNotice || "ìµœì‹  ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.";

            // ì„±ì (ì½ê¸° ì „ìš©)
            renderParentScore(s.scoreLog || []);

            // ì¶œì„ ìˆ˜
            const now = new Date();
            const logs = (s.attendanceLog || []).map(ts => ts.toDate ? ts.toDate() : new Date(ts.seconds * 1000));
            const count = logs.filter(d => d.getMonth() === now.getMonth()).length;
            document.getElementById('sAtt').innerText = count;

            // ê¸°ë¡ (ìƒë‹´ + ì•Œë¦¼ì¥)
            // [ìˆ˜ì •] ì „ì²´ ê¸°ë¡ í‘œì‹œ (ìµœì‹ ìˆœ ì •ë ¬)
            const list = document.getElementById('historyList');
            list.innerHTML = "";
            const history = s.counselLog || [];
            
            // ë°°ì—´ ë³µì‚¬ í›„ ì—­ìˆœ ì •ë ¬ (ì›ë³¸ í›¼ì† ë°©ì§€)
            const history = [...(s.counselLog || [])].reverse();

            if(history.length === 0) list.innerHTML = "<div style='text-align:center; color:#999; padding:20px;'>ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>";
            else {
                history.reverse().forEach(h => {
                history.forEach(h => {
                    const isNotice = h.text.includes("[ì•Œë¦¼ì¥]");
                    const tag = isNotice ? '<span class="tag tag-notice">ì•Œë¦¼ì¥</span>' : '<span class="tag tag-counsel">ì§€ë„ë‚´ì—­</span>';
                    // íƒœê·¸ ì œê±°í•˜ê³  ë³¸ë¬¸ë§Œ ê¹”ë”í•˜ê²Œ
                    const cleanText = h.text.replace("[ì•Œë¦¼ì¥]", "").trim();
                    
                    list.innerHTML += `
                        <div class="log-item">
                            <div style="font-size:12px; color:#94a3b8; margin-bottom:4px;">${h.date}</div>
                            <div style="font-size:13px; color:#64748b; margin-bottom:4px; font-weight:bold;">ğŸ“… ${h.date}</div>
                            ${tag}
                            <div style="margin-top:6px; line-height:1.5; white-space:pre-wrap;">${cleanText}</div>
                        </div>`;
                });
            }
        }

        // 3. ë©”ì‹œì§€ ì „ì†¡
        window.sendReply = async () => {
            const msg = document.getElementById('replyMsg').value.trim();
            if(!msg) return alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

            try {
                await addDoc(collection(db, "parentMessages"), {
                    parentPhone: (currentStudent.phone || '').toString(),
                    studentId: currentStudent.id,
                    studentName: currentStudent.name,
                    message: msg,
@@ -253,6 +202,68 @@
                document.getElementById('replyMsg').value = "";
            } catch(e) { alert("ì „ì†¡ ì‹¤íŒ¨: " + e.message); }
        };

        // 4. [ì¶”ê°€] ë‚´ê°€ ë³´ë‚¸ ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ê¸° & ìˆ˜ì •/ì‚­ì œ ê¸°ëŠ¥
        function loadMyMessages() {
            if(!currentStudent) return;
            const listArea = document.getElementById('myMsgList');

            // ë‚´ í•™ìƒ IDë¡œ ëœ ë©”ì‹œì§€ë§Œ ì‹¤ì‹œê°„ ê°ì‹œ
            // (ì£¼ì˜: ì¸ë±ìŠ¤ ì˜¤ë¥˜ ë°©ì§€ë¥¼ ìœ„í•´ orderByëŠ” jsì—ì„œ ì²˜ë¦¬í•˜ê±°ë‚˜, ì—ëŸ¬ë‚˜ë©´ ìƒì„± ë§í¬ í´ë¦­ í•„ìš”)
            const q = query(
                collection(db, "parentMessages"), 
                where("studentId", "==", currentStudent.id)
            );

            onSnapshot(q, (snapshot) => {
                const msgs = [];
                snapshot.forEach(doc => msgs.push({ id: doc.id, ...doc.data() }));
                
                // ìµœì‹ ìˆœ ì •ë ¬ (í´ë¼ì´ì–¸íŠ¸ ì¸¡ ì •ë ¬)
                msgs.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));

                if(msgs.length === 0) {
                    listArea.innerHTML = "<div style='text-align:center; color:#cbd5e1; padding:10px;'>ë³´ë‚¸ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>";
                    return;
                }

                listArea.innerHTML = "";
                msgs.forEach(m => {
                    const date = m.createdAt ? new Date(m.createdAt.seconds * 1000).toLocaleString() : "ë°©ê¸ˆ ì „";
                    const isRead = m.read ? '<span style="color:#3b82f6;">(ì½ìŒ)</span>' : '<span style="color:#ef4444;">(ì•ˆì½ìŒ)</span>';
                    
                    listArea.innerHTML += `
                        <div class="my-msg-item">
                            <div class="msg-meta">
                                <span>${date} ${isRead}</span>
                                <div class="msg-actions">
                                    <button class="btn-edit" onclick="window.editMsg('${m.id}', '${m.message.replace(/'/g, "\\'")}')">ìˆ˜ì •</button>
                                    <button class="btn-del" onclick="window.delMsg('${m.id}')">ì‚­ì œ</button>
                                </div>
                            </div>
                            <div style="white-space:pre-wrap; font-size:14px;">${m.message}</div>
                        </div>
                    `;
                });
            });
        }

        // ìˆ˜ì • ê¸°ëŠ¥
        window.editMsg = async (id, oldText) => {
            const newText = prompt("ë©”ì‹œì§€ë¥¼ ìˆ˜ì •í•˜ì„¸ìš”:", oldText);
            if(newText === null || newText.trim() === "") return;
            try {
                await updateDoc(doc(db, "parentMessages", id), { message: newText });
            } catch(e) { alert("ìˆ˜ì • ì‹¤íŒ¨: " + e.message); }
        };

        // ì‚­ì œ ê¸°ëŠ¥
        window.delMsg = async (id) => {
            if(!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            try {
                await deleteDoc(doc(db, "parentMessages", id));
            } catch(e) { alert("ì‚­ì œ ì‹¤íŒ¨: " + e.message); }
        };
    </script>
</body>
