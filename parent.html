<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•™ë¶€ëª¨ ì „ìš© | ë¯¸ë˜ì—”ìˆ˜í•™</title>
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
    <style>
        body { margin: 0; padding: 20px; font-family: 'Pretendard', sans-serif; background: #f1f5f9; color: #333; }
        .container { max-width: 600px; margin: 0 auto; }
        
        /* ë¡œê·¸ì¸ í™”ë©´ */
        #login-screen { text-align: center; margin-top: 60px; }
        .login-card { background: white; padding: 40px 20px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
        .login-input { width: 100%; padding: 16px; font-size: 18px; border: 2px solid #e2e8f0; border-radius: 12px; margin: 20px 0; box-sizing: border-box; text-align: center; outline: none; transition: 0.2s; }
        .login-input:focus { border-color: #3b82f6; }
        .login-btn { width: 100%; padding: 16px; background: #3b82f6; color: white; border: none; border-radius: 12px; font-weight: bold; font-size: 18px; cursor: pointer; transition: 0.2s; }
        .login-btn:active { transform: scale(0.98); }

        /* ë©”ì¸ í™”ë©´ */
        .card { background: white; border-radius: 20px; padding: 25px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        h2 { margin: 0 0 5px; font-size: 22px; color: #1e293b; }
        .tag { display: inline-block; padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: bold; margin-bottom: 6px; }
        .tag-notice { background: #fff7ed; color: #c2410c; }
        .tag-counsel { background: #eff6ff; color: #1d4ed8; }
        .log-item { border-bottom: 1px dashed #e2e8f0; padding: 12px 0; }
        
        /* í•™ë¶€ëª¨ ì…ë ¥ì°½: ì‘ì•„ì„œ ì•ˆ ë³´ì¸ë‹¤ëŠ” í”¼ë“œë°± ë°˜ì˜ */
        textarea { width: 100%; height: 160px; padding: 14px; border: 1px solid #cbd5e1; border-radius: 14px; box-sizing: border-box; resize: vertical; font-size: 16px; line-height: 1.5; }
        .send-btn { width: 100%; padding: 14px; background: #10b981; color: white; border: none; border-radius: 12px; font-weight: bold; font-size: 16px; margin-top: 10px; cursor: pointer; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

    <div class="container">
        <div id="login-screen">
            <div class="login-card">
                <img src="nam-192.png" style="width:80px; border-radius:20px; box-shadow: 0 8px 20px rgba(0,0,0,0.1); margin-bottom:20px;">
                <h2 style="margin-bottom:10px;">í•™ë¶€ëª¨ ì¸ì¦</h2>
                <p style="color:#64748b; font-size:15px; line-height:1.5;">
                    ì„ ìƒë‹˜ê»˜ ë“±ë¡ëœ <b>í•™ë¶€ëª¨ë‹˜ ì „í™”ë²ˆí˜¸</b>ë¥¼<br>ì…ë ¥í•´ì£¼ì„¸ìš”. (ìˆ«ìë§Œ ì…ë ¥)
                </p>
                <input type="tel" id="inputPhone" class="login-input" placeholder="01012345678">
                <button class="login-btn" onclick="checkParent()">ë‚´ ìë…€ ì¡°íšŒí•˜ê¸°</button>
            </div>
        </div>

        <div id="content-screen" style="display:none;">
            <div class="card" style="text-align:center;">
                <h2 id="sName">-</h2>
                <p id="sInfo" style="color:#64748b;">-</p>
                <div style="background:#f0f9ff; color:#0369a1; padding:12px; border-radius:12px; font-weight:bold; margin-top:15px;">
                    ğŸ“… ì´ë²ˆ ë‹¬ ë“±ì›: <span id="sAtt" style="font-size:1.2em;">0</span>íšŒ
                </div>
            </div>

            <div class="card">
                <h3 style="margin-top:0;">ğŸ“¢ ìµœì‹  ì•Œë¦¼ì¥</h3>
                <div id="sNotice" style="background:#fffbeb; padding:15px; border-radius:12px; border:1px solid #fcd34d; line-height:1.6; white-space:pre-wrap; color:#451a03;">(ë‚´ìš© ì—†ìŒ)</div>
            </div>

            <div class="card">
                <h3 style="margin-top:0;">ğŸ—‚ï¸ ì§€ë‚œ í•™ìŠµ/ìƒë‹´ ê¸°ë¡</h3>
                <div id="historyList" style="max-height:420px; overflow-y:auto;"></div>
            </div>

            <div class="card">
                <h3 style="margin-top:0;">ğŸ“ˆ ì„±ì  ê·¸ë˜í”„/ê¸°ë¡</h3>
                <div style="background:#f5f3ff; border:1px solid #ddd6fe; padding:14px; border-radius:12px;">
                    <canvas id="parentScoreChart" height="180"></canvas>
                    <div id="parentScoreList" style="margin-top:12px; font-size:14px; line-height:1.5; color:#475569;"></div>
                </div>
            </div>

            <div class="card">
                <h3 style="margin-top:0;">ğŸ’¬ ì„ ìƒë‹˜ê»˜ ë‹µì¥í•˜ê¸°</h3>
                <textarea id="replyMsg" placeholder="ì„ ìƒë‹˜ê»˜ ë“œë¦´ ë§ì”€ì´ë‚˜ ê¶ê¸ˆí•œ ì ì„ ì ì–´ì£¼ì„¸ìš”."></textarea>
                <button class="send-btn" onclick="sendReply()">ë©”ì‹œì§€ ë³´ë‚´ê¸°</button>
            </div>
            
            <button onclick="location.reload()" style="width:100%; padding:12px; background:#94a3b8; color:white; border:none; border-radius:12px; margin-top:20px; font-weight:bold;">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, query, where, addDoc, serverTimestamp, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDPLl5y5xMBL07yLyQDU185qfYLa4c3yv4",
            authDomain: "namyang-f3a98.firebaseapp.com",
            projectId: "namyang-f3a98",
            storageBucket: "namyang-f3a98.firebasestorage.app",
            messagingSenderId: "641432133626",
            appId: "1:641432133626:web:4d31e36d5dbb0db4df4e43",
            measurementId: "G-23L6KZERMF"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
// =========================================================
// [ì¶”ê°€] Firestore ê¶Œí•œì„ ìœ„í•œ ìµëª… ë¡œê·¸ì¸ (Anonymous Auth)
// =========================================================
const auth = getAuth(app);
let __authReadyResolve;
const __authReady = new Promise(res => (__authReadyResolve = res));
onAuthStateChanged(auth, (u) => { if(u) __authReadyResolve(u); });
if(!auth.currentUser){
  signInAnonymously(auth).catch(e => {
    console.error("Anonymous sign-in failed", e);
    alert("Firebase ìµëª… ë¡œê·¸ì¸ ì‹¤íŒ¨: " + (e?.message || e));
  });
}

let currentStudent = null;
        let unsubStudent = null;
        let parentChart = null;

        window.checkParent = async () => {
            const phoneInput = document.getElementById('inputPhone');
            const phone = phoneInput.value.toString().replace(/\D/g,'').trim();
            
            if(phone.length < 8) return alert("ì „í™”ë²ˆí˜¸ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.");

            const btn = document.querySelector('.login-btn');
            const originalText = btn.innerText;
            btn.innerText = "ì¡°íšŒ ì¤‘...";
            btn.disabled = true;

            try {
                await __authReady;

                // ë¶€ëª¨ë‹˜ ë²ˆí˜¸ë¡œ í•™ìƒ ê²€ìƒ‰
                const q = query(collection(db, "students"), where("phone", "==", phone));
                const snap = await getDocs(q);

                if(snap.empty) {
                    alert("ë“±ë¡ëœ ë²ˆí˜¸ê°€ ì—†ìŠµë‹ˆë‹¤.\nì„ ìƒë‹˜ê»˜ í™•ì¸í•´ì£¼ì„¸ìš”.");
                    btn.innerText = originalText;
                    btn.disabled = false;
                    return;
                }

                // ë¡œê·¸ì¸ ì„±ê³µ: í•™ìƒ docë¥¼ ì‹¤ì‹œê°„ êµ¬ë…í•´ì„œ
                // ì„ ìƒë‹˜ì´ ìƒë‹´/ì•Œë¦¼ì„ ì¶”ê°€í•´ë„ ë¶€ëª¨ í™”ë©´ì´ ìë™ìœ¼ë¡œ ê°±ì‹ ë˜ê²Œ í•¨
                const id = snap.docs[0].id;
                if (unsubStudent) try { unsubStudent(); } catch(e) {}
                unsubStudent = onSnapshot(doc(db, "students", id), (docSnap) => {
                    if(!docSnap.exists()) return;
                    currentStudent = { id: docSnap.id, ...docSnap.data() };
                    showData();
                });

            } catch(e) {
                console.error(e);
                alert("ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                btn.innerText = originalText;
                btn.disabled = false;
            }
        };

        function renderParentScore(scoreLog = []) {
            const canvas = document.getElementById('parentScoreChart');
            const listEl = document.getElementById('parentScoreList');
            if(!canvas || !listEl) return;

            // ë¦¬ìŠ¤íŠ¸
            if(!Array.isArray(scoreLog) || scoreLog.length === 0) {
                listEl.innerHTML = "<div style='text-align:center; color:#94a3b8; padding:10px;'>ë“±ë¡ëœ ì„±ì ì´ ì—†ìŠµë‹ˆë‹¤.</div>";
            } else {
                const rows = scoreLog.slice().reverse().map(s => {
                    const date = s.date || '';
                    const title = s.title || 'ì‹œí—˜';
                    const score = (s.score ?? '');
                    return `<div style="padding:8px 0; border-bottom:1px dashed #e2e8f0;">
                        <div style="font-size:12px; color:#94a3b8;">${date}</div>
                        <div style="display:flex; justify-content:space-between; gap:10px;">
                            <div style="font-weight:800; color:#1e293b;">${title}</div>
                            <div style="font-weight:900; color:#7c3aed;">${score}ì </div>
                        </div>
                    </div>`;
                }).join('');
                listEl.innerHTML = rows;
            }

            // ì°¨íŠ¸
            if(!window.Chart) return;
            const ctx = canvas.getContext('2d');
            if(parentChart) { try { parentChart.destroy(); } catch(e){} }

            const labels = (scoreLog || []).map(s => s.title || '');
            const data = (scoreLog || []).map(s => Number(s.score || 0));

            parentChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'ì„±ì ',
                        data,
                        tension: 0.25,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, suggestedMax: 100 }
                    }
                }
            });
        }

        function showData() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('content-screen').style.display = 'block';
            
            const s = currentStudent;
            document.getElementById('sName').innerText = s.name + " í•™ìƒ";
            document.getElementById('sInfo').innerText = `${s.school||''} | ${s.belt||''}`;
            document.getElementById('sNotice').innerText = s.lastNotice || "ìµœì‹  ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.";

            // ì„±ì (ì½ê¸° ì „ìš©)
            renderParentScore(s.scoreLog || []);

            // ì¶œì„ ìˆ˜
            const now = new Date();
            const logs = (s.attendanceLog || []).map(ts => ts.toDate ? ts.toDate() : new Date(ts.seconds * 1000));
            const count = logs.filter(d => d.getMonth() === now.getMonth()).length;
            document.getElementById('sAtt').innerText = count;

            // ê¸°ë¡ (ìƒë‹´ + ì•Œë¦¼ì¥)
            const list = document.getElementById('historyList');
            list.innerHTML = "";
            const history = s.counselLog || [];
            
            if(history.length === 0) list.innerHTML = "<div style='text-align:center; color:#999; padding:20px;'>ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>";
            else {
                history.reverse().forEach(h => {
                    const isNotice = h.text.includes("[ì•Œë¦¼ì¥]");
                    const tag = isNotice ? '<span class="tag tag-notice">ì•Œë¦¼ì¥</span>' : '<span class="tag tag-counsel">ì§€ë„ë‚´ì—­</span>';
                    const cleanText = h.text.replace("[ì•Œë¦¼ì¥]", "").trim();
                    list.innerHTML += `
                        <div class="log-item">
                            <div style="font-size:12px; color:#94a3b8; margin-bottom:4px;">${h.date}</div>
                            ${tag}
                            <div style="margin-top:6px; line-height:1.5; white-space:pre-wrap;">${cleanText}</div>
                        </div>`;
                });
            }
        }

        window.sendReply = async () => {
            const msg = document.getElementById('replyMsg').value.trim();
            if(!msg) return alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            
            try {
                await addDoc(collection(db, "parentMessages"), {
                    parentPhone: (currentStudent.phone || '').toString().replace(/\D/g,''),
                    studentId: currentStudent.id,
                    studentName: currentStudent.name,
                    message: msg,
                    createdAt: serverTimestamp(),
                    read: false
                });
                alert("ì„ ìƒë‹˜ê»˜ ë©”ì‹œì§€ë¥¼ ë³´ëƒˆìŠµë‹ˆë‹¤! âœ…");
                document.getElementById('replyMsg').value = "";
            } catch(e) { alert("ì „ì†¡ ì‹¤íŒ¨: " + e.message); }
        };
    </script>
</body>
</html>
