<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ë¯¸ë˜ì—”ìˆ˜í•™ Â· í•™ë¶€ëª¨ ì•Œë¦¼ í™•ì¸</title>
<link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
<style>
body{margin:0;font-family:Pretendard,system-ui;background:#f8fafc;color:#0f172a;padding:16px}
.card{max-width:720px;margin:0 auto;background:#fff;border:1px solid rgba(15,23,42,.08);border-radius:18px;padding:14px;box-shadow:0 10px 26px rgba(2,6,23,.08)}
h1{font-size:18px;margin:0 0 10px}
label{display:block;font-size:12px;font-weight:800;color:#475569;margin:10px 0 6px}
input,select,textarea{width:100%;padding:12px;border-radius:14px;border:1px solid rgba(15,23,42,.12);font-size:14px;box-sizing:border-box}
button{width:100%;padding:12px;border:none;border-radius:14px;background:#3b82f6;color:#fff;font-weight:900;font-size:14px;cursor:pointer;margin-top:10px}
.small{font-size:12px;color:#64748b;line-height:1.5}
.notice{white-space:pre-wrap;background:#f1f5f9;border-radius:14px;padding:12px;border:1px solid rgba(15,23,42,.08);min-height:80px}
hr{border:none;border-top:1px solid rgba(15,23,42,.08);margin:14px 0}
</style>
</head>
<body>
  <div class="card">
    <h1>ğŸ“© í•™ë¶€ëª¨ ì•Œë¦¼ í™•ì¸</h1>
    <div class="small">ì„ ìƒë‹˜ì´ ì €ì¥í•œ <b>ìµœê·¼ ì•Œë¦¼ì¥</b>ì„ í™•ì¸í•˜ê³ , ì˜ê²¬ì„ ë‚¨ê¸¸ ìˆ˜ ìˆì–´ìš”.</div>

    <label>í•™ìƒ ì„ íƒ</label>
    <select id="studentSelect"><option value="">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</option></select>

    <label>ìµœê·¼ ì•Œë¦¼ì¥</label>
    <div id="noticeBox" class="notice">í•™ìƒì„ ì„ íƒí•˜ë©´ í‘œì‹œë©ë‹ˆë‹¤.</div>

    <hr/>

    <h1 style="font-size:16px;margin-top:0;">ğŸ“ í•™ë¶€ëª¨ ì˜ê²¬ ë³´ë‚´ê¸°</h1>
    <label>ì˜ê²¬ ë‚´ìš©</label>
    <textarea id="msg" rows="4" placeholder="ì„ ìƒë‹˜ê»˜ ì „ë‹¬í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”."></textarea>
    <button id="sendBtn">ì˜ê²¬ ë³´ë‚´ê¸°</button>

    <div id="status" class="small" style="margin-top:10px;"></div>
  </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, getDocs, query, where, addDoc, serverTimestamp, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDPLl5y5xMBL07yLyQDU185qfYLa4c3yv4",
        authDomain: "namyang-f3a98.firebaseapp.com",
        projectId: "namyang-f3a98",
        storageBucket: "namyang-f3a98.firebasestorage.app",
        messagingSenderId: "641432133626",
        appId: "1:641432133626:web:4d31e36d5dbb0db4df4e43",
        measurementId: "G-23L6KZERMF"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let currentStudent = null;
    let unsubStudent = null;
    let parentChart = null;

    // [ì¤‘ìš”] ì „í™”ë²ˆí˜¸ ì¡°íšŒ ê¸°ëŠ¥ ê°•í™” (í•˜ì´í”ˆ ìœ ë¬´ ìƒê´€ì—†ì´ ì°¾ê¸°)
    window.checkParent = async () => {
        const rawInput = document.getElementById('inputPhone').value.trim();
        const cleanInput = rawInput.replace(/-/g, ''); // ìˆ«ìë§Œ ë‚¨ê¹€

        if(cleanInput.length < 8) return alert("ì „í™”ë²ˆí˜¸ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.");

        const btn = document.querySelector('.login-btn');
        const originalText = btn.innerText;
        btn.innerText = "ì¡°íšŒ ì¤‘...";
        btn.disabled = true;

        try {
            const studentsRef = collection(db, "students");
            let snap;

            // ì‹œë„ 1: ì…ë ¥í•œ ìˆ«ì ê·¸ëŒ€ë¡œ ì¡°íšŒ (ì˜ˆ: 01012345678)
            let q = query(studentsRef, where("phone", "==", cleanInput));
            snap = await getDocs(q);

            // ì‹œë„ 2: ì‹¤íŒ¨í–ˆë‹¤ë©´, í•˜ì´í”ˆ ë„£ì€ í˜•ì‹ìœ¼ë¡œ ì¡°íšŒ (ì˜ˆ: 010-1234-5678)
            if(snap.empty && cleanInput.length === 11) {
                const formatted = cleanInput.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
                q = query(studentsRef, where("phone", "==", formatted));
                snap = await getDocs(q);
            }

            // ì‹œë„ 3: ê·¸ë˜ë„ ì—†ë‹¤ë©´ ì…ë ¥í•œ ê°’ ê·¸ëŒ€ë¡œ ì¡°íšŒ (í˜¹ì‹œ ëª¨ë¥¼ í¬ë§·)
            if(snap.empty) {
                q = query(studentsRef, where("phone", "==", rawInput));
                snap = await getDocs(q);
            }

            if(snap.empty) {
                alert("ë“±ë¡ëœ ë²ˆí˜¸ê°€ ì—†ìŠµë‹ˆë‹¤.\nì„ ìƒë‹˜ê»˜ ë²ˆí˜¸ê°€ ì •í™•í•œì§€ í™•ì¸í•´ì£¼ì„¸ìš”.");
                btn.innerText = originalText;
                btn.disabled = false;
                return;
            }

            // ì¡°íšŒ ì„±ê³µ!
            const id = snap.docs[0].id;
            
            // ì‹¤ì‹œê°„ ë°ì´í„° ì—°ê²°
            if (unsubStudent) try { unsubStudent(); } catch(e) {}
            unsubStudent = onSnapshot(doc(db, "students", id), (docSnap) => {
                if(!docSnap.exists()) return;
                currentStudent = { id: docSnap.id, ...docSnap.data() };
                showData();
            });

        } catch(e) {
            console.error(e);
            alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + e.message);
            btn.innerText = originalText;
            btn.disabled = false;
        }
    };

    function showData() {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('content-screen').style.display = 'block';
        
        const s = currentStudent;
        document.getElementById('sName').innerText = s.name + " í•™ìƒ";
        document.getElementById('sInfo').innerText = `${s.school||''} | ${s.belt||''}`;
        document.getElementById('sNotice').innerText = s.lastNotice || "ìµœì‹  ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.";

        // ì„±ì  ê·¸ë˜í”„
        renderParentScore(s.scoreLog || []);

        // ì¶œì„ ìˆ˜ ê³„ì‚°
        const now = new Date();
        const logs = (s.attendanceLog || []).map(ts => ts.toDate ? ts.toDate() : new Date(ts.seconds * 1000));
        const count = logs.filter(d => d.getMonth() === now.getMonth()).length;
        document.getElementById('sAtt').innerText = count;

        // ê¸°ë¡ (ìƒë‹´ + ì•Œë¦¼ì¥)
        const list = document.getElementById('historyList');
        list.innerHTML = "";
        const history = s.counselLog || [];
        
        if(history.length === 0) list.innerHTML = "<div style='text-align:center; color:#999; padding:20px;'>ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>";
        else {
            [...history].reverse().forEach(h => {
                const isNotice = h.text.includes("[ì•Œë¦¼ì¥]");
                const tag = isNotice ? '<span class="tag tag-notice">ì•Œë¦¼ì¥</span>' : '<span class="tag tag-counsel">ì§€ë„ë‚´ì—­</span>';
                const cleanText = h.text.replace("[ì•Œë¦¼ì¥]", "").trim();
                list.innerHTML += `
                    <div class="log-item">
                        <div style="font-size:12px; color:#94a3b8; margin-bottom:4px;">${h.date}</div>
                        ${tag}
                        <div style="margin-top:6px; line-height:1.5; white-space:pre-wrap;">${cleanText}</div>
                    </div>`;
            });
        }
    }

    // [ì¤‘ìš”] ë©”ì‹œì§€ ì „ì†¡ ì‹œ ì»¬ë ‰ì…˜ ì´ë¦„ ì¼ì¹˜ (parentMessages)
    window.sendReply = async () => {
        const msg = document.getElementById('replyMsg').value.trim();
        if(!msg) return alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        
        const btn = document.querySelector('.send-btn');
        btn.disabled = true;
        btn.innerText = "ì „ì†¡ ì¤‘...";

        try {
            await addDoc(collection(db, "parentMessages"), {
                parentPhone: (currentStudent.phone || '').toString(),
                studentId: currentStudent.id,
                studentName: currentStudent.name,
                message: msg,
                createdAt: serverTimestamp(),
                read: false
            });
            alert("ì„ ìƒë‹˜ê»˜ ë©”ì‹œì§€ë¥¼ ë³´ëƒˆìŠµë‹ˆë‹¤! âœ…");
            document.getElementById('replyMsg').value = "";
        } catch(e) { 
            alert("ì „ì†¡ ì‹¤íŒ¨: " + e.message); 
        } finally {
            btn.disabled = false;
            btn.innerText = "ë©”ì‹œì§€ ë³´ë‚´ê¸°";
        }
    };

    function renderParentScore(scoreLog) {
        const canvas = document.getElementById('parentScoreChart');
        const listEl = document.getElementById('parentScoreList');
        if(!canvas || !listEl) return;

        if(!Array.isArray(scoreLog) || scoreLog.length === 0) {
            listEl.innerHTML = "<div style='text-align:center; color:#94a3b8; padding:10px;'>ë“±ë¡ëœ ì„±ì ì´ ì—†ìŠµë‹ˆë‹¤.</div>";
        } else {
            const rows = [...scoreLog].reverse().map(s => {
                return `<div style="padding:8px 0; border-bottom:1px dashed #e2e8f0;">
                    <div style="font-size:12px; color:#94a3b8;">${s.date||''}</div>
                    <div style="display:flex; justify-content:space-between; gap:10px;">
                        <div style="font-weight:800; color:#1e293b;">${s.title||'ì‹œí—˜'}</div>
                        <div style="font-weight:900; color:#7c3aed;">${s.score}ì </div>
                    </div>
                </div>`;
            }).join('');
            listEl.innerHTML = rows;
        }

        if(!window.Chart) return;
        const ctx = canvas.getContext('2d');
        if(parentChart) { try { parentChart.destroy(); } catch(e){} }

        const labels = scoreLog.map(s => s.title || '');
        const data = scoreLog.map(s => Number(s.score || 0));

        parentChart = new Chart(ctx, {
            type: 'line',
            data: { labels, datasets: [{ label: 'ì„±ì ', data, tension: 0.25, fill: true }] },
            options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, suggestedMax: 100 } } }
        });
    }
</script>
</body>
</html>
