<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¯¸ë˜ì—”ìˆ˜í•™ ëŠ¥ë™í•´ëƒ„ êµì‹¤ ê´€ë¦¬</title>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3B82F6">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://t1.kakaocdn.net/kakao_js_sdk/2.7.0/kakao.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* =========================================
           ê¸°ë³¸ ìŠ¤íƒ€ì¼ ë° UI (ì„ ìƒë‹˜/í‚¤ì˜¤ìŠ¤í¬ ê³µí†µ)
           ========================================= */
        :root{ --brand-blue:#3B82F6; --bg:#F8FAFC; --ink:#0F172A; }
        *{ box-sizing:border-box; }
        body{ margin:0; padding:14px 12px 20px; font-family:'Pretendard', sans-serif; background:var(--bg); color:var(--ink); }

        /* ì»¨í…Œì´ë„ˆ */
        .container{ max-width:860px; margin:0 auto; background:rgba(255,255,255,0.8); border-radius:20px; padding:14px; box-shadow:0 10px 30px rgba(0,0,0,0.05); }

        /* í—¤ë” */
        header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; }
        .brand{ display:flex; align-items:center; gap:14px; }
        .brand-mark{ width:54px; height:54px; border-radius:18px; background:white; object-fit:contain; box-shadow:0 4px 12px rgba(59,130,246,0.25); }
        .brand-title strong{ display:block; font-size:21px; letter-spacing:-0.5px; margin-bottom:3px; }
        .brand-title span{ font-size:13px; color:#64748b; }
        
        /* íƒ­ ë„¤ë¹„ê²Œì´ì…˜ (ìƒë‹¨ ê³ ì •) */
        .tabs{ position:sticky; top:0; z-index:90; display:flex; gap:8px; padding:8px; background:rgba(255,255,255,0.95); backdrop-filter:blur(10px); border-radius:0 0 16px 16px; margin:0 -14px 15px; width:calc(100% + 28px); border-bottom:1px solid rgba(0,0,0,0.05); }
        .tab-btn{ flex:1; border:none; background:transparent; padding:10px 0; font-size:14px; font-weight:800; color:#64748b; cursor:pointer; border-radius:12px; }
        .tab-btn.active{ background:#eff6ff; color:#1d4ed8; }

        /* í˜ì´ì§€ ì „í™˜ */
        .page{ display:none; animation:fadeIn .2s; }
        .page.active{ display:block; }
        @keyframes fadeIn{ from{opacity:0; transform:translateY(5px)} to{opacity:1} }

        /* ì…ë ¥ í¼ */
        .form-grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
        .full-width{ grid-column:1/-1; }
        label{ display:block; font-size:12px; font-weight:800; color:#64748b; margin-bottom:6px; }
        input, select, textarea{ width:100%; padding:12px; border-radius:12px; border:1px solid #e2e8f0; font-size:14px; background:white; outline:none; }
        textarea{ resize:vertical; }
        .action-btn{ width:100%; padding:14px; border-radius:16px; background:#3b82f6; color:white; font-weight:bold; border:none; margin-top:10px; cursor:pointer; box-shadow:0 4px 12px rgba(59,130,246,0.3); }

        /* ë¦¬ìŠ¤íŠ¸ (ì„ ìƒë‹˜ ëª¨ë“œ) */
        #studentListArea{ display:grid; grid-template-columns:1fr; gap:10px; }
        .student-card{ background:white; border:1px solid #e2e8f0; border-radius:20px; padding:12px 14px; display:flex; gap:12px; align-items:center; cursor:pointer; transition:0.2s; height:auto; box-shadow:0 2px 5px rgba(0,0,0,0.03); }
        .profile-wrapper{ width:64px; height:64px; flex-shrink:0; }
        .profile-img{ width:100%; height:100%; border-radius:20px; object-fit:cover; border:1px solid #f1f5f9; }
        .info-area{ flex:1; }
        .info-area div:first-child{ font-size:17px; font-weight:900; margin-bottom:4px; }
        .info-area small{ font-size:13px; color:#64748b; }
        
        /* ìº˜ë¦°ë” */
        .calendar-controls{ display:flex; justify-content:space-between; align-items:center; padding:10px; background:white; border-radius:16px; margin-bottom:10px; }
        .cal-btn{ border:none; background:none; font-size:18px; cursor:pointer; padding:5px 10px; }
        .calendar-grid{ display:grid; grid-template-columns:repeat(7,1fr); gap:5px; text-align:center; }
        .day-name{ font-size:12px; color:#64748b; padding:5px 0; }
        .day-cell{ background:white; border-radius:12px; min-height:60px; padding:5px; border:1px solid #f1f5f9; cursor:pointer; display:flex; flex-direction:column; align-items:center; }
        .day-cell.today{ border:2px solid #3b82f6; }
        .event-dot{ width:6px; height:6px; border-radius:50%; margin:1px; }
        .dot-schedule{ background:#3b82f6; } .dot-birthday{ background:#facc15; }

        /* í•™ë¶€ëª¨ ì˜ê²¬í•¨ */
        #inboxList .msg-box{ background:white; border:1px solid #e2e8f0; border-radius:12px; padding:15px; margin-bottom:10px; }
        #inboxList .msg-unread{ background:#fff7ed; border-color:#fdba74; }

        /* ê´€ë¦¬ì ëª¨ë“œ ì „ìš© */
        .admin-only{ display:none !important; }
        body.show-admin .admin-only{ display:inline-block !important; }
        body.show-admin div.info-box.admin-only { display:block !important; }

        /* =========================================
           í‚¤ì˜¤ìŠ¤í¬ ëª¨ë“œ (ì¶œì„ë¶€) ìŠ¤íƒ€ì¼
           ========================================= */
        body.kiosk-mode{ padding:0; background:#f1f5f9; }
        body.kiosk-mode .container{ max-width:100%; background:transparent; box-shadow:none; border-radius:0; padding:10px; }
        body.kiosk-mode header, body.kiosk-mode .tabs, body.kiosk-mode #register, body.kiosk-mode #calendar, body.kiosk-mode #inbox{ display:none !important; }
        
        body.kiosk-mode #list{ display:block !important; }
        body.kiosk-mode #studentListArea{ grid-template-columns:repeat(auto-fill, minmax(220px, 1fr)); gap:15px; padding:10px; }
        
        .kiosk-header{ display:none; gap:8px; padding:10px; justify-content:center; flex-wrap:wrap; }
        body.kiosk-mode .kiosk-header{ display:flex; }
        .k-filter-btn{ background:white; border:1px solid #cbd5e1; border-bottom:4px solid #94a3b8; border-radius:12px; padding:12px 20px; font-weight:800; color:#64748b; cursor:pointer; }
        .k-filter-btn.active{ background:#fffbeb; color:#b45309; border-color:#fcd34d; border-bottom-width:2px; transform:translateY(2px); }

        body.kiosk-mode .student-card{ height:300px; flex-direction:column; justify-content:center; text-align:center; padding:15px; transition:0.3s; }
        body.kiosk-mode .profile-wrapper{ width:100px; height:100px; margin-bottom:15px; }
        body.kiosk-mode .profile-img{ border-radius:30px; }
        body.kiosk-mode .info-area div:first-child{ font-size:20px; margin-bottom:5px; }

        /* í‚¤ì˜¤ìŠ¤í¬ ìƒíƒœë³„ ì¹´ë“œ */
        body.kiosk-mode .student-card.missing{ background:white; border:1px solid #e2e8f0; box-shadow:0 6px 0 #cbd5e1; }
        body.kiosk-mode .student-card.arrived{ background:linear-gradient(135deg, #fff 50%, #dcfce7 100%); border:3px solid #22c55e; box-shadow:0 6px 0 #15803d; transform:translateY(-2px); }
        body.kiosk-mode .student-card.left{ opacity:0.6; filter:grayscale(100%); transform:scale(0.95); border:2px dashed #94a3b8; box-shadow:none; }
        
        .kiosk-pill{ position:absolute; top:15px; right:15px; padding:6px 12px; border-radius:20px; font-weight:bold; font-size:13px; background:#f1f5f9; color:#64748b; }
        body.kiosk-mode .student-card.arrived .kiosk-pill{ background:#22c55e; color:white; }

        .kiosk-exit-btn{ display:none; position:fixed; bottom:20px; left:20px; width:40px; height:40px; opacity:0.3; z-index:999; cursor:pointer; font-size:24px; }
        body.kiosk-mode .kiosk-exit-btn{ display:block; }

        /* ëª¨ë‹¬ (ìƒì„¸ì°½) */
        .modal-overlay{ display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:100; justify-content:center; align-items:center; }
        .modal{ width:min(500px, 96vw); max-height:90vh; background:white; border-radius:24px; display:flex; flex-direction:column; overflow:hidden; position:relative; }
        .modal-header-fixed{ background:white; padding:20px 20px 10px; border-bottom:1px solid #eee; flex-shrink:0; }
        .modal-tab-nav{ margin:0 20px; flex-shrink:0; margin-top:10px; }
        .modal-tab-btn{ padding:10px; border:none; background:transparent; font-weight:bold; color:#94a3b8; cursor:pointer; }
        .modal-tab-btn.active{ color:#3b82f6; border-bottom:2px solid #3b82f6; }
        .modal-body-scroll{ flex:1; overflow-y:auto; padding:20px; background:#f8fafc; }
        .close-btn{ position:absolute; top:15px; right:15px; width:32px; height:32px; border-radius:50%; border:none; background:#f1f5f9; font-size:20px; cursor:pointer; }
        
        .info-box{ background:white; border:1px solid #e2e8f0; border-radius:12px; padding:15px; margin-bottom:15px; }
        .info-box h4{ margin:0 0 10px 0; font-size:15px; border-bottom:2px solid #f1f5f9; padding-bottom:8px; }
        #modalEditForm{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
        #modalEditForm .full-row{ grid-column:1/-1; }
    </style>
</head>
<body>

    <div class="kiosk-exit-btn" onclick="exitKioskMode()">ğŸ”’</div>

    <div class="container">
        <div class="kiosk-header">
            <button class="k-filter-btn active" onclick="setKioskCategory('all', this)">ì „ì²´</button>
            <button class="k-filter-btn" onclick="setKioskCategory('ë¯¸ì·¨í•™', this)">ë¯¸ì·¨í•™</button>
            <button class="k-filter-btn" onclick="setKioskCategory('ì´ˆë“±', this)">ì´ˆë“±ë¶€</button>
            <button class="k-filter-btn" onclick="setKioskCategory('ì¤‘ë“±', this)">ì¤‘ë“±ë¶€</button>
            <button class="k-filter-btn" onclick="setKioskCategory('ê³ ë“±', this)">ê³ ë“±ë¶€</button>
        </div>

        <header>
            <div class="brand">
                <img class="brand-mark" src="nam-512.png" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3468/3468306.png'">
                <div class="brand-title"><strong>ë¯¸ë˜ì—”ìˆ˜í•™ ëŠ¥ë™í•´ëƒ„</strong><span>í•™ë¶€ëª¨ìš© Â· ì•Œë¦¼/ì¶œì„/ìƒë‹´</span></div>
            </div>
            <div style="display:flex; align-items:center; gap:8px;">
                <label style="font-size:13px; font-weight:bold; color:#64748b; cursor:pointer;">
                    <input type="checkbox" id="adminToggle" onclick="toggleAdminMode()"> ì„ ìƒë‹˜
                </label>
                <button class="admin-only" onclick="document.getElementById('settingsModal').style.display='flex'" style="border:none; background:white; width:36px; height:36px; border-radius:50%; box-shadow:0 2px 5px rgba(0,0,0,0.1); color:#555; cursor:pointer;"><i class="fas fa-cog"></i></button>
            </div>
        </header>

        <div class="tabs">
            <button class="tab-btn active" onclick="showPage('register')"><i class="fas fa-user-plus"></i> ì‹ ê·œ ë“±ë¡</button>
            <button class="tab-btn" onclick="showPage('list')"><i class="fas fa-users"></i> ì›ìƒ ê´€ë¦¬</button>
            <button class="tab-btn" onclick="showPage('calendar')"><i class="fas fa-calendar-alt"></i> í•™ìŠµ ì¼ì •</button>
            <button class="tab-btn admin-only" onclick="showPage('inbox')"><i class="fas fa-inbox"></i> í•™ë¶€ëª¨ ì˜ê²¬ <span id="inboxBadge" style="display:none; background:#ef4444; color:white; border-radius:10px; padding:2px 6px; font-size:10px;">N</span></button>
        </div>

        <div id="register" class="page active">
            <div class="form-grid">
                <div class="full-width"><label>í•™ìƒ ì‚¬ì§„</label><input type="file" id="regPhoto" accept="image/*"></div>
                <div><label>ì´ë¦„</label><input type="text" id="regName"></div>
                <div><label>ìƒë…„ì›”ì¼</label><input type="date" id="regBirth"></div>
                <div><label>ì„±ë³„</label><select id="regGender"><option value="ë‚¨">ë‚¨</option><option value="ì—¬">ì—¬</option></select></div>
                <div><label>í•™êµ</label><input type="text" id="regSchool"></div>
                <div><label>í•™ë…„/ê³¼ì •</label><select id="regGrade"><option value="ë¯¸ì·¨í•™">ë¯¸ì·¨í•™</option><option value="ì´ˆë“±1-2">ì´ˆë“±1-2</option><option value="ì´ˆë“±3-4">ì´ˆë“±3-4</option><option value="ì´ˆë“±5-6">ì´ˆë“±5-6</option><option value="ì¤‘ë“±ë¶€">ì¤‘ë“±ë¶€</option><option value="ê³ ë“±ë¶€">ê³ ë“±ë¶€</option></select></div>
                <div class="full-width"><label>ë¶€ëª¨ë‹˜ ì—°ë½ì²˜</label><input type="tel" id="regParentPhone" placeholder="01012345678"></div>
                <div class="full-width"><label>í•™ìƒ ì—°ë½ì²˜</label><input type="tel" id="regStudentPhone"></div>
                <div class="full-width"><label>íŠ¹ì´ì‚¬í•­</label><textarea id="regNotes"></textarea></div>
            </div>
            <button class="action-btn" id="addBtn">í•™ìƒ ë“±ë¡í•˜ê¸°</button>
        </div>

        <div id="list" class="page">
            <div class="form-grid" style="margin-bottom:15px; display:flex; gap:10px;">
                <input type="text" id="searchKeyword" placeholder="ì´ë¦„ ê²€ìƒ‰" onkeyup="filterList()" style="flex:1;">
                <select id="schoolFilter" onchange="filterList()" style="width:auto;"><option value="all">ì „ì²´ í•™êµ</option></select>
            </div>
            <div id="studentListArea">ë¡œë”©ì¤‘...</div>
        </div>

        <div id="calendar" class="page">
            <div class="calendar-controls">
                <button class="cal-btn" onclick="changeCalDate(-1)">â—€</button>
                <div id="calTitle" style="font-size:18px; font-weight:bold;"></div>
                <button class="cal-btn" onclick="changeCalDate(1)">â–¶</button>
            </div>
            <div style="text-align:center; margin-bottom:10px;">
                <label style="margin-right:15px;"><input type="checkbox" id="showSchedule" checked onchange="renderCalendar()"> í•™ì›ì¼ì •</label>
                <label><input type="checkbox" id="showBirthday" checked onchange="renderCalendar()"> ìƒì¼</label>
            </div>
            <div class="calendar-grid">
                <div class="day-name" style="color:red">ì¼</div><div class="day-name">ì›”</div><div class="day-name">í™”</div><div class="day-name">ìˆ˜</div><div class="day-name">ëª©</div><div class="day-name">ê¸ˆ</div><div class="day-name" style="color:blue">í† </div>
            </div>
            <div id="calGrid" class="calendar-grid"></div>
            <div id="dailyEventList" style="margin-top:20px; padding:15px; background:white; border-radius:12px; min-height:50px;"></div>
        </div>

        <div id="inbox" class="page">
            <div style="background:white; padding:15px; border-radius:12px; margin-bottom:15px;">
                <h3 style="margin:0;">ğŸ“¨ í•™ë¶€ëª¨ ì˜ê²¬í•¨</h3>
                <p style="font-size:13px; color:#64748b; margin-top:5px;">í•™ë¶€ëª¨ ì•±ì—ì„œ ë³´ë‚¸ ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
            </div>
            <div id="inboxList" style="max-height:500px; overflow-y:auto;"></div>
        </div>
    </div>

    <div class="modal-overlay" id="detailModal">
        <div class="modal">
            <button class="close-btn" onclick="closeModal()">Ã—</button>
            
            <div class="modal-header-fixed">
                <div style="text-align:center;">
                    <div style="width:70px; height:70px; margin:0 auto 10px; position:relative;" onclick="triggerPhotoEdit()">
                        <img id="modalImg" src="" style="width:100%; height:100%; border-radius:24px; object-fit:cover; border:1px solid #e2e8f0;">
                        <div class="admin-only" style="position:absolute; bottom:-5px; right:-5px; background:#3b82f6; color:white; width:24px; height:24px; line-height:24px; text-align:center; border-radius:50%; font-size:12px;"><i class="fas fa-camera"></i></div>
                    </div>
                    <h2 id="modalName" style="margin:0 0 4px 0; font-size:18px;"></h2>
                    <div id="modalInfo" style="color:#64748b; font-size:13px; margin-bottom:12px;"></div>
                    
                    <div style="display:flex; justify-content:center; gap:10px;">
                        <a id="linkCallPar" class="admin-only" style="padding:6px 12px; background:#eff6ff; border-radius:20px; color:#1d4ed8; font-size:12px; text-decoration:none;">ğŸ“ ë¶€ëª¨ë‹˜</a>
                        <a id="linkCallStu" class="admin-only" style="padding:6px 12px; background:#f0fdf4; border-radius:20px; color:#15803d; font-size:12px; text-decoration:none;">ğŸ“ í•™ìƒ</a>
                    </div>
                    <input type="file" id="editPhotoInput" accept="image/*" style="display:none;" onchange="previewEditPhoto()">
                </div>
            </div>

            <div class="modal-tab-nav">
                <button class="modal-tab-btn active" onclick="switchModalTab('tabDaily', this)">í•™ìŠµ/ì¶œì„</button>
                <button class="modal-tab-btn" onclick="switchModalTab('tabScore', this)">ì„±ì /ê¸°ë¡</button>
                <button class="modal-tab-btn" onclick="switchModalTab('tabInfo', this)">ì •ë³´/ì •ì‚°</button>
            </div>

            <div class="modal-body-scroll">
                <div id="tabDaily" class="modal-tab-pane active">
                    <div class="info-box" style="display:flex; justify-content:space-around;">
                        <div style="text-align:center;"><div id="statMonth" style="font-size:20px; font-weight:bold; color:#3b82f6;">0íšŒ</div><div style="font-size:12px;">ì´ë²ˆë‹¬ ë“±ì›</div></div>
                        <div style="text-align:center;"><div id="statTotal" style="font-size:20px; font-weight:bold; color:#3b82f6;">0íšŒ</div><div style="font-size:12px;">ëˆ„ì  ë“±ì›</div></div>
                    </div>
                    <div class="info-box" style="background:#fffbeb; border-color:#fcd34d;">
                        <h4 style="color:#d97706;">ğŸ“¢ ì•Œë¦¼ì¥ ì „ì†¡</h4>
                        <textarea id="dailyProgress" rows="3" placeholder="ë‚´ìš© ì…ë ¥..." style="background:white; margin-bottom:8px;"></textarea>
                        <div id="noticePreview" style="display:none; background:white; padding:10px; border:1px solid #fcd34d; margin-bottom:8px; font-size:13px;"></div>
                        <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px;">
                            <button class="action-btn" onclick="generateNotice()" style="margin:0; background:#f59e0b;">ë¬¸êµ¬ ìƒì„±</button>
                            <button class="action-btn" onclick="sendNoticeSms()" style="margin:0; background:#22c55e;"><i class="fas fa-envelope"></i> ë¬¸ì</button>
                            <button class="action-btn" onclick="sendNoticeKakao()" style="margin:0; background:#fee500; color:#3c1e1e;"><i class="fas fa-comment"></i> ì¹´í†¡</button>
                        </div>
                    </div>
                </div>
                <div id="tabScore" class="modal-tab-pane">
                    <div class="info-box">
                        <h4>ğŸ“ˆ ì„±ì  ê´€ë¦¬</h4>
                        <div class="admin-only" style="display:flex; gap:5px; margin-bottom:10px;">
                            <input type="text" id="scoreTitle" placeholder="ì‹œí—˜ëª…" style="flex:2;">
                            <input type="number" id="scoreValue" placeholder="ì ìˆ˜" style="flex:1;">
                            <button onclick="addScore()" style="background:#7b1fa2; color:white; border:none; border-radius:8px; width:50px;">ì¶”ê°€</button>
                        </div>
                        <canvas id="scoreChart" height="200"></canvas>
                        <div id="scoreList" style="margin-top:10px; font-size:13px;"></div>
                    </div>
                    <div class="info-box">
                        <h4>ğŸ’¬ ìƒë‹´ ê¸°ë¡</h4>
                        <div class="admin-only" style="display:flex; gap:5px; margin-bottom:10px;">
                            <input type="text" id="newCounsel" placeholder="ìƒë‹´ ë‚´ìš©">
                            <button onclick="addCounselLog()" style="background:#3b82f6; color:white; border:none; border-radius:8px; width:50px;">ë“±ë¡</button>
                        </div>
                        <div id="modalCounselLog" style="max-height:150px; overflow-y:auto; font-size:13px;"></div>
                    </div>
                </div>
                <div id="tabInfo" class="modal-tab-pane">
                    <div class="info-box" style="background:#f0f9ff; border-color:#bae6fd;">
                        <h4 style="color:#0369a1;">ğŸ’° êµìœ¡ë¹„ ì •ì‚° ì•ˆë‚´</h4>
                        <div id="settlementPreview" style="background:white; padding:10px; border:1px solid #bae6fd; font-size:12px; margin-bottom:8px; min-height:60px;"></div>
                        <div style="display:flex; gap:8px;">
                            <button onclick="generateSettlement()" class="action-btn" style="margin:0; background:#0ea5e9; font-size:13px;">ë¬¸êµ¬ ìƒì„±</button>
                            <button onclick="copyText('settlementPreview')" class="action-btn" style="margin:0; background:#0284c7; font-size:13px;">ë³µì‚¬</button>
                        </div>
                    </div>
                    <div class="info-box admin-only">
                        <h4>âš™ï¸ ì •ë³´ ìˆ˜ì •</h4>
                        <div id="modalEditForm">
                            <input type="hidden" id="editId">
                            <div class="full-row"><label>ì´ë¦„</label><input type="text" id="editName"></div>
                            <div><label>í•™êµ</label><input type="text" id="editSchool"></div>
                            <div><label>í•™ë…„</label><select id="editGrade"><option value="ë¯¸ì·¨í•™">ë¯¸ì·¨í•™</option><option value="ì´ˆë“±1-2">ì´ˆë“±1-2</option><option value="ì´ˆë“±3-4">ì´ˆë“±3-4</option><option value="ì´ˆë“±5-6">ì´ˆë“±5-6</option><option value="ì¤‘ë“±ë¶€">ì¤‘ë“±ë¶€</option><option value="ê³ ë“±ë¶€">ê³ ë“±ë¶€</option></select></div>
                            <div class="full-row"><label>ë¶€ëª¨ ì „í™”</label><input type="tel" id="editParentPhone"></div>
                            <div class="full-row"><label>í•™ìƒ ì „í™”</label><input type="tel" id="editStudentPhone"></div>
                            <div class="full-row"><label>ë©”ëª¨</label><textarea id="editNotes"></textarea></div>
                        </div>
                        <div style="display:flex; gap:10px; margin-top:15px;">
                            <button onclick="saveEdit()" style="flex:2; padding:12px; background:#3b82f6; color:white; border:none; border-radius:12px;">ì €ì¥</button>
                            <button onclick="deleteStudent()" style="flex:1; padding:12px; background:#ef4444; color:white; border:none; border-radius:12px;">ì‚­ì œ</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="scheduleModal">
        <div class="modal" style="width:340px; height:auto;">
            <h3 style="margin:20px;">ğŸ“… ì¼ì • ê´€ë¦¬</h3>
            <div style="padding:0 20px 20px;">
                <input type="date" id="schedDate" style="margin-bottom:10px;">
                <input type="text" id="schedTitle" placeholder="ì¼ì • ë‚´ìš©" style="margin-bottom:10px;">
                <input type="hidden" id="schedId">
                <div id="popupSchedList" style="margin-bottom:15px; max-height:100px; overflow-y:auto; font-size:13px; border:1px solid #eee; padding:5px;"></div>
                <div style="display:flex; gap:5px;">
                    <button class="action-btn" onclick="saveSchedule()" style="margin:0;">ì €ì¥</button>
                    <button class="action-btn" onclick="deleteSchedule()" style="margin:0; background:#ef4444;">ì‚­ì œ</button>
                    <button class="action-btn" onclick="document.getElementById('scheduleModal').style.display='none'" style="margin:0; background:#94a3b8;">ë‹«ê¸°</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="settingsModal">
        <div class="modal" style="width:300px; height:auto; padding:20px;">
            <h3>ì„¤ì •</h3>
            <button class="action-btn" onclick="startKioskMode()" style="background:#f59e0b;">ì¶œì„ë¶€ ëª¨ë“œ ì‹œì‘</button>
            <button class="action-btn" onclick="downloadExcel()" style="background:#10b981;">ì—‘ì…€ ì €ì¥</button>
            <button class="action-btn" onclick="downloadBackup()" style="background:#3b82f6;">ë°±ì—… ì €ì¥</button>
            <button class="action-btn" onclick="document.getElementById('restoreInput').click()" style="background:#7c3aed;">ë³µêµ¬ í•˜ê¸°</button>
            <button class="action-btn" onclick="document.getElementById('settingsModal').style.display='none'" style="background:#94a3b8;">ë‹«ê¸°</button>
            <input type="file" id="restoreInput" accept=".json" style="display:none" onchange="restoreData(event)">
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, query, where, addDoc, serverTimestamp, doc, onSnapshot, updateDoc, deleteDoc, arrayUnion, orderBy, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDPLl5y5xMBL07yLyQDU185qfYLa4c3yv4",
            authDomain: "namyang-f3a98.firebaseapp.com",
            projectId: "namyang-f3a98",
            storageBucket: "namyang-f3a98.firebasestorage.app",
            messagingSenderId: "641432133626",
            appId: "1:641432133626:web:4d31e36d5dbb0db4df4e43",
            measurementId: "G-23L6KZERMF"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // ì „ì—­ ë³€ìˆ˜
        window.allStudents = []; window.allSchedules = []; window.currentStudentId = null;
        let selectedDateStr = new Date().toISOString().slice(0, 10);
        let currentKioskCategory = 'all'; let calDate = new Date(); let myChart = null;

        const LS_TEACHER = 'teacherMode'; const LS_KIOSK = 'kioskMode';
        function isTeacherMode(){ return localStorage.getItem(LS_TEACHER) === '1'; }
        function setTeacherMode(on){ if(on) localStorage.setItem(LS_TEACHER,'1'); else localStorage.removeItem(LS_TEACHER); }
        function isKioskSaved(){ return localStorage.getItem(LS_KIOSK) === '1'; }
        function setKioskSaved(on){ if(on) localStorage.setItem(LS_KIOSK,'1'); else localStorage.removeItem(LS_KIOSK); }

        function applyAccessUI(){
            const teacher = isTeacherMode(); const kiosk = document.body.classList.contains('kiosk-mode');
            document.body.classList.toggle('show-admin', teacher && !kiosk);
            const chk = document.getElementById('adminToggle'); if(chk) chk.checked = teacher;
            document.querySelectorAll('.tab-btn').forEach(btn => {
                const oc = btn.getAttribute('onclick')||'';
                if(!teacher && !kiosk && (oc.includes('register') || oc.includes('list') || oc.includes('inbox'))) btn.style.display='none';
                else btn.style.display='';
            });
        }

        // DB ë¦¬ìŠ¤ë„ˆ
        onSnapshot(collection(db, "students"), (snapshot) => {
            window.allStudents = []; snapshot.forEach(d => window.allStudents.push({id:d.id, ...d.data()}));
            updateSchoolOptions(); filterList(); if(window.renderCalendar) window.renderCalendar();
            if(window.currentStudentId) { const s = window.allStudents.find(st=>st.id===window.currentStudentId); if(s) window.openDetail(s); }
        });
        onSnapshot(query(collection(db, "schedules"), orderBy("date")), (snapshot) => {
            window.allSchedules = []; snapshot.forEach(d => window.allSchedules.push({id:d.id, ...d.data()}));
            if(window.renderCalendar) window.renderCalendar();
        });

        // í•™ë¶€ëª¨ ì˜ê²¬í•¨
        const inboxListEl = document.getElementById('inboxList');
        if(inboxListEl) {
            onSnapshot(collection(db, "parentMessages"), (snapshot) => {
                let msgs = []; snapshot.forEach(d => msgs.push({id:d.id, ...d.data()}));
                msgs.sort((a,b) => (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0));
                
                let unread = 0; let html = "";
                if(msgs.length === 0) html = "<div style='text-align:center; padding:20px; color:#999;'>ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>";
                else msgs.forEach(d => {
                    if(!d.read) unread++;
                    const bg = d.read ? "white" : "#fff7ed";
                    html += `<div style="background:${bg}; padding:15px; margin-bottom:10px; border:1px solid #e2e8f0; border-radius:12px;">
                        <div style="font-weight:bold; margin-bottom:5px; display:flex; justify-content:space-between;">
                            <span>${d.studentName} (${d.parentPhone})</span>
                            <div>
                                <button onclick="openMessageStudent('${d.studentId}')" style="font-size:12px; padding:4px 8px; border:none; background:#3b82f6; color:white; border-radius:4px; cursor:pointer;">í•™ìƒ ì—´ê¸°</button>
                                ${!d.read ? `<button onclick="markMessageRead('${d.id}')" style="font-size:12px; padding:4px 8px; border:none; background:#10b981; color:white; border-radius:4px; cursor:pointer; margin-left:4px;">ì½ìŒ</button>`:''}
                            </div>
                        </div>
                        <div style="font-size:14px; color:#333;">${d.message}</div>
                    </div>`;
                });
                inboxListEl.innerHTML = html;
                const badge = document.getElementById('inboxBadge'); if(badge) { badge.style.display = unread>0?'inline-block':'none'; badge.innerText = unread; }
            });
        }

        window.markMessageRead = async (id) => await updateDoc(doc(db, "parentMessages", id), {read:true});
        window.openMessageStudent = (sid) => { if(!isTeacherMode()) window.toggleAdminMode(true); window.showPage('list'); setTimeout(()=>window.openDetailById(sid), 500); };

        // ë¦¬ìŠ¤íŠ¸ í•„í„°
        window.filterList = () => {
            const kw = document.getElementById('searchKeyword')?.value.toLowerCase() || "";
            const sc = document.getElementById('schoolFilter')?.value || "all";
            const today = new Date().toDateString();
            const isKiosk = document.body.classList.contains('kiosk-mode');

            let filtered = window.allStudents.filter(s => {
                if(isKiosk) return currentKioskCategory==='all' || (s.belt||'').includes(currentKioskCategory);
                return (s.name||"").includes(kw) && (sc==='all' || s.school===sc);
            });
            filtered.sort((a,b)=>a.name.localeCompare(b.name));

            const area = document.getElementById('studentListArea'); area.innerHTML = "";
            if(filtered.length===0) { area.innerHTML="<div style='color:#999; padding:20px;'>ê²°ê³¼ ì—†ìŒ</div>"; return; }

            filtered.forEach(s => {
                const arrived = (s.attendanceLog||[]).some(l=>new Date(l.seconds?l.seconds*1000:l).toDateString()===today);
                const left = (s.attendanceOutLog||[]).some(l=>new Date(l.seconds?l.seconds*1000:l).toDateString()===today);
                const state = left?'left':(arrived?'arrived':'missing');
                const div = document.createElement('div'); div.id = `card-${s.id}`; div.className = `student-card ${state}`;
                const img = s.photo || "https://via.placeholder.com/150";

                if(isKiosk) {
                    const txt = left?'í•˜ì› ì™„ë£Œ':(arrived?'ë“±ì› ì™„ë£Œ':'ë¯¸ë“±ì›');
                    div.innerHTML = `<div class="kiosk-pill ${state}">${txt}</div><div class="profile-wrapper"><img src="${img}" class="profile-img"></div><div class="info-area"><div>${s.name}</div><small>${s.school||''}</small></div>`;
                    div.onclick = () => window.kioskTapAttendance(s.id);
                } else {
                    div.innerHTML = `<div class="profile-wrapper"><img src="${img}" class="profile-img"></div><div class="info-area"><div>${s.name} <span style="font-size:12px; background:#eff6ff; color:#1d4ed8; padding:2px 6px; border-radius:10px;">${s.belt||''}</span></div><small>${s.school||''}</small></div>`;
                    div.onclick = () => window.openDetail(s);
                }
                area.appendChild(div);
            });
        };

        // ìƒì„¸ íŒì—…
        window.openDetail = (s) => {
            window.currentStudentId = s.id;
            const modal = document.getElementById('detailModal'); modal.style.display='flex';
            document.getElementById('modalImg').src = s.photo || "https://via.placeholder.com/150";
            document.getElementById('modalName').innerText = s.name;
            document.getElementById('modalInfo').innerText = `${s.school||''} | ${s.belt||''}`;
            
            const p = (s.phone||"").replace(/[^0-9]/g,''); const st = (s.studentPhone||"").replace(/[^0-9]/g,'');
            document.getElementById('linkCallPar').href = p?`tel:${p}`:"#"; document.getElementById('linkCallStu').href = st?`tel:${st}`:"#";

            document.getElementById('editId').value = s.id; document.getElementById('editName').value = s.name; document.getElementById('editSchool').value = s.school; document.getElementById('editGrade').value = s.belt; document.getElementById('editBirth').value = s.birth; document.getElementById('editGender').value = s.gender; document.getElementById('editParentPhone').value = s.phone; document.getElementById('editStudentPhone').value = s.studentPhone; document.getElementById('editNotes').value = s.notes;

            if(window.renderScoreChart) window.renderScoreChart(s.scoreLog||[]); window.renderCounselLog(s); window.calcStats(s);
            document.getElementById('dailyProgress').value=""; document.getElementById('noticePreview').style.display='none';
        };
        window.openDetailById = (id) => { const s = window.allStudents.find(st=>st.id===id); if(s) window.openDetail(s); };
        window.closeModal = () => { document.getElementById('detailModal').style.display='none'; window.currentStudentId=null; };

        // ì°¨íŠ¸ & ê¸°ë¡
        window.renderScoreChart = (logs) => {
            const ctx = document.getElementById('scoreChart').getContext('2d'); if(myChart) myChart.destroy();
            myChart = new Chart(ctx, {type:'line', data:{labels:logs.map(l=>l.title), datasets:[{label:'ì„±ì ', data:logs.map(l=>l.score), borderColor:'#3b82f6', fill:true, backgroundColor:'rgba(59,130,246,0.1)'}]}, options:{responsive:true, plugins:{legend:{display:false}}, scales:{y:{min:0, max:100}}}});
            document.getElementById('scoreList').innerHTML = logs.map((l,i)=>`<div style="display:flex; justify-content:space-between; padding:5px; border-bottom:1px solid #eee;"><span>${l.title}</span><span>${l.score}ì  <span onclick="deleteScore(${i})" style="color:red; cursor:pointer;">Ã—</span></span></div>`).reverse().join('');
        };
        window.renderCounselLog = (s) => {
            document.getElementById('modalCounselLog').innerHTML = (s.counselLog||[]).map((l,i)=>`<div style="padding:5px; border-bottom:1px solid #eee; font-size:13px;">[${l.date}] ${l.text} <span onclick="deleteCounselLog(${i})" style="float:right; color:red; cursor:pointer;">Ã—</span></div>`).reverse().join('');
        };
        window.calcStats = (s) => {
            const now = new Date(); const logs = s.attendanceLog||[];
            document.getElementById('statTotal').innerText = logs.length+"íšŒ";
            document.getElementById('statMonth').innerText = logs.filter(l=>new Date(l.seconds?l.seconds*1000:l).getMonth()===now.getMonth()).length+"íšŒ";
        };

        // ë°ì´í„° ì¡°ì‘
        window.addScore = async () => { await updateDoc(doc(db,"students",window.currentStudentId), {scoreLog:arrayUnion({date:new Date().toLocaleDateString(), title:document.getElementById('scoreTitle').value, score:document.getElementById('scoreValue').value})}); document.getElementById('scoreTitle').value=""; document.getElementById('scoreValue').value=""; };
        window.deleteScore = async (i) => { if(confirm('ì‚­ì œ?')) { const s=window.allStudents.find(st=>st.id===window.currentStudentId); const n=s.scoreLog.filter((_,idx)=>idx!==i); await updateDoc(doc(db,"students",window.currentStudentId),{scoreLog:n}); } };
        window.addCounselLog = async () => { await updateDoc(doc(db,"students",window.currentStudentId), {counselLog:arrayUnion({date:new Date().toLocaleDateString(), text:document.getElementById('newCounsel').value})}); document.getElementById('newCounsel').value=""; };
        window.deleteCounselLog = async (i) => { if(confirm('ì‚­ì œ?')) { const s=window.allStudents.find(st=>st.id===window.currentStudentId); const n=s.counselLog.filter((_,idx)=>idx!==i); await updateDoc(doc(db,"students",window.currentStudentId),{counselLog:n}); } };
        window.saveEdit = async () => { await updateDoc(doc(db,"students",document.getElementById('editId').value), {name:document.getElementById('editName').value, school:document.getElementById('editSchool').value, belt:document.getElementById('editGrade').value, phone:document.getElementById('editParentPhone').value, studentPhone:document.getElementById('editStudentPhone').value, notes:document.getElementById('editNotes').value}); alert("ì €ì¥ë¨"); };
        window.deleteStudent = async () => { if(confirm("ì‚­ì œ?")) { await deleteDoc(doc(db,"students",window.currentStudentId)); window.closeModal(); } };

        // ì•Œë¦¼ì¥
        window.generateNotice = () => {
            const s=window.allStudents.find(st=>st.id===window.currentStudentId); const txt=document.getElementById('dailyProgress').value;
            if(!txt) return alert("ë‚´ìš© ì…ë ¥");
            const msg=`[ë¯¸ë˜ì—”ìˆ˜í•™] ì•Œë¦¼ì¥ ğŸ“¢\n${s.name} í•™ìƒ í•™ìŠµë‚´ìš©:\n${txt}`;
            const box=document.getElementById('noticePreview'); box.innerText=msg; box.style.display='block'; return msg;
        };
        window.sendNoticeSms = () => { const s=window.allStudents.find(st=>st.id===window.currentStudentId); if(s.phone) location.href=`sms:${s.phone.replace(/-/g,'')}?body=${encodeURIComponent(window.generateNotice())}`; };
        window.sendNoticeKakao = async () => {
            const s=window.allStudents.find(st=>st.id===window.currentStudentId); const txt=document.getElementById('dailyProgress').value; if(!txt) return alert("ë‚´ìš© ì…ë ¥");
            const url = location.origin+'/parent.html'; const msg=`[ì•Œë¦¼ì¥] ${s.name}\n${txt}\ní™•ì¸: ${url}`;
            await updateDoc(doc(db,'students',window.currentStudentId), {lastNotice:txt, counselLog:arrayUnion({date:new Date().toLocaleDateString(), text:'[ì•Œë¦¼ì¥] '+txt})});
            navigator.clipboard.writeText(msg).then(()=>alert("ë³µì‚¬ë¨. ì¹´í†¡ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”."));
        };
        window.generateSettlement = () => { const s=window.allStudents.find(st=>st.id===window.currentStudentId); document.getElementById('settlementPreview').innerText=`[ì•ˆë‚´] ${s.name} êµìœ¡ë¹„ ë‚©ë¶€ ê¸°ê°„ì…ë‹ˆë‹¤.`; };
        window.copyText = (id) => navigator.clipboard.writeText(document.getElementById(id).innerText).then(()=>alert("ë³µì‚¬ë¨"));

        // ìº˜ë¦°ë”
        window.renderCalendar = () => {
            const y=calDate.getFullYear(), m=calDate.getMonth(); document.getElementById('calTitle').innerText=`${y}ë…„ ${m+1}ì›”`;
            const grid=document.getElementById('calGrid'); grid.innerHTML="";
            const evts=[];
            if(document.getElementById('showSchedule').checked) window.allSchedules.forEach(e=>evts.push({...e, type:'schedule'}));
            if(document.getElementById('showBirthday').checked) window.allStudents.forEach(s=>{if(s.birth&&s.birth.includes(`-${String(m+1).padStart(2,'0')}-`)) evts.push({date:`${y}-${s.birth.slice(5)}`, type:'birthday'})});

            const first=new Date(y,m,1).getDay(); const last=new Date(y,m+1,0).getDate();
            for(let i=0; i<first; i++) grid.innerHTML+=`<div></div>`;
            for(let d=1; d<=last; d++) {
                const ds=`${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const dots=evts.filter(e=>e.date===ds).map(e=>`<div class="event-dot dot-${e.type}"></div>`).join('');
                grid.innerHTML+=`<div class="day-cell ${ds===selectedDateStr?'today':''}" onclick="clickDate('${ds}')"><span class="day-num">${d}</span><div style="display:flex;">${dots}</div></div>`;
            }
            const list=document.getElementById('dailyEventList'); const dayEvts=window.allSchedules.filter(e=>e.date===selectedDateStr);
            list.innerHTML=dayEvts.length?dayEvts.map(e=>`<div>ğŸ“… ${e.title}</div>`).join(''):"<div style='color:#ccc'>ì¼ì • ì—†ìŒ</div>";
        };
        window.clickDate=(d)=>{selectedDateStr=d; window.renderCalendar(); if(isTeacherMode()) window.openScheduleModal('','',d);};
        window.changeCalDate=(n)=>{calDate.setMonth(calDate.getMonth()+n); window.renderCalendar();};
        window.openScheduleModal=(id,t,d)=>{const m=document.getElementById('scheduleModal'); m.style.display='flex'; document.getElementById('schedId').value=id||''; document.getElementById('schedTitle').value=t||''; document.getElementById('schedDate').value=d||selectedDateStr; 
            document.getElementById('popupSchedList').innerHTML=window.allSchedules.filter(s=>s.date===(d||selectedDateStr)).map(s=>`<div onclick="document.getElementById('schedId').value='${s.id}';document.getElementById('schedTitle').value='${s.title}';">ğŸ“… ${s.title}</div>`).join('');
        };
        window.saveSchedule=async()=>{const id=document.getElementById('schedId').value; const t=document.getElementById('schedTitle').value; const d=document.getElementById('schedDate').value; if(id) await updateDoc(doc(db,"schedules",id),{title:t,date:d}); else await addDoc(collection(db,"schedules"),{title:t,date:d}); document.getElementById('scheduleModal').style.display='none';};
        window.deleteSchedule=async()=>{if(confirm('ì‚­ì œ?')) await deleteDoc(doc(db,"schedules",document.getElementById('schedId').value)); document.getElementById('scheduleModal').style.display='none';};

        // í‚¤ì˜¤ìŠ¤í¬
        window.startKioskMode=()=>{if(confirm("ì¶œì„ë¶€ ëª¨ë“œ?")){setKioskSaved(true); document.body.classList.add('kiosk-mode'); applyAccessUI(); window.showPage('list');}};
        window.exitKioskMode=()=>{if(prompt("ë¹„ë²ˆ")==="1234"){setKioskSaved(false); document.body.classList.remove('kiosk-mode'); applyAccessUI(); window.showPage('list');}};
        window.setKioskCategory=(c,b)=>{currentKioskCategory=c; document.querySelectorAll('.k-filter-btn').forEach(bb=>bb.classList.remove('active')); b.classList.add('active'); window.filterList();};
        window.kioskTapAttendance=async(id)=>{
            const s=window.allStudents.find(st=>st.id===id); const today=new Date().toDateString();
            const arr=(s.attendanceLog||[]).some(l=>new Date(l.seconds?l.seconds*1000:l).toDateString()===today);
            const msg=arr?`${s.name}, í•˜ì›!`:`${s.name}, ë“±ì›!`;
            if(window.speechSynthesis){const u=new SpeechSynthesisUtterance(msg); window.speechSynthesis.speak(u);}
            const now=new Date(); if(!arr) await updateDoc(doc(db,"students",id),{attendanceLog:arrayUnion(now)}); else await updateDoc(doc(db,"students",id),{attendanceOutLog:arrayUnion(now)});
        };

        // ìœ í‹¸
        window.toggleAdminMode=(f)=>{const chk=document.getElementById('adminToggle'); if(f===true||chk.checked){if(f!==true&&prompt("ë¹„ë²ˆ")!=="1234"){chk.checked=false;return;}setTeacherMode(true);}else setTeacherMode(false); applyAccessUI(); window.showPage(isTeacherMode()?'list':'calendar');};
        window.showPage=(id)=>{document.querySelectorAll('.page').forEach(p=>p.classList.remove('active')); document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); document.getElementById(id).classList.add('active'); 
            const t=document.querySelectorAll('.tab-btn'); if(id==='register')t[0].classList.add('active'); if(id==='list')t[1].classList.add('active'); if(id==='calendar')t[2].classList.add('active'); if(id==='inbox')t[3].classList.add('active');
            if(id==='calendar')window.renderCalendar(); if(id==='list')window.filterList();
        };
        window.setGradeFilter=(v,b)=>{currentGradeFilter=v; document.querySelectorAll('.filter-chip').forEach(c=>c.classList.remove('active')); b.classList.add('active'); window.filterList();};
        window.updateSchoolOptions=()=>{const ss=new Set(); window.allStudents.forEach(s=>s.school&&ss.add(s.school)); const sel=document.getElementById('schoolFilter'); sel.innerHTML='<option value="all">ì „ì²´ í•™êµ</option>'; ss.forEach(sc=>sel.innerHTML+=`<option value="${sc}">${sc}</option>`);};
        window.triggerPhotoEdit=()=>{if(isTeacherMode())document.getElementById('editPhotoInput').click();};
        window.previewEditPhoto=async()=>{const f=document.getElementById('editPhotoInput').files[0]; if(f){const r=new FileReader(); r.onload=e=>{document.getElementById('modalImg').src=e.target.result;}; r.readAsDataURL(f);}};
        window.switchModalTab=(id,b)=>{document.querySelectorAll('.modal-tab-pane').forEach(p=>p.style.display='none'); document.getElementById(id).style.display='block'; document.querySelectorAll('.modal-tab-btn').forEach(bb=>bb.classList.remove('active')); b.classList.add('active');};
        window.downloadExcel=()=>{const d=window.allStudents.map((s,i)=>({"ì´ë¦„":s.name,"í•™êµ":s.school})); const ws=XLSX.utils.json_to_sheet(d); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"ëª…ë‹¨"); XLSX.writeFile(wb,"ëª…ë‹¨.xlsx");};
        window.downloadBackup=()=>{const b=new Blob([JSON.stringify(window.allStudents)],{type:"application/json"}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download="backup.json"; a.click();};
        window.restoreData=(e)=>{const r=new FileReader(); r.onload=async(ev)=>{const d=JSON.parse(ev.target.result); if(confirm(d.length+"ëª… ë³µêµ¬?")){for(const s of d){const{id,...rr}=s; await addDoc(collection(db,"students"),{...rr,regDate:serverTimestamp()});}alert("ì™„ë£Œ");}}; r.readAsText(e.target.files[0]);};

        window.onload=()=>{const k=isKioskSaved(); if(k)document.body.classList.add('kiosk-mode'); applyAccessUI(); window.showPage(isTeacherMode()||k?'list':'calendar');};
    </script>
</body>
</html>
